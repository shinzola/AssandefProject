<!DOCTYPE html>
<html lang="pt-br" xmlns:th="http://www.thymeleaf.org">
<head th:replace="~{fragments/base :: headPadrao('Gest√£o de Atendimentos')}">
</head>

<body>

<header th:replace="~{fragments/base :: cabecalho}"></header>

<div class="container mt-3" th:if="${(msg != null and !#strings.isEmpty(msg)) or (erro != null and !#strings.isEmpty(erro))}">
    <div class="alert alert-success alert-dismissible fade show" role="alert"
         th:if="${msg != null and !#strings.isEmpty(msg)}">
        <span th:text="${msg}">A√ß√£o realizada com sucesso!</span>
        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
    </div>

    <div class="alert alert-danger alert-dismissible fade show" role="alert"
         th:if="${erro != null and !#strings.isEmpty(erro)}">
        <span th:text="${erro}">Ocorreu um erro</span>
        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
    </div>
</div>


<main class="main-page">
    <div class="container-fluid">
        <div class="page-header">
            <h1 class="page-title">Gest√£o de Atendimentos</h1>
            <div class="page-actions">
                <button class="btn btn-outline-secondary" data-bs-toggle="modal" data-bs-target="#modalGerarRelatorio">
                    <i class="bi bi-file-earmark-arrow-down me-2"></i>Gerar Relat√≥rio
                </button>
                <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#modalNovoAtendimento">
                    <i class="bi bi-plus-circle me-2"></i>Novo Atendimento
                </button>
            </div>
        </div>


        <!-- === TABS PRINCIPAIS === -->
        <ul class="nav nav-tabs mt-3" id="atendimentoTabs" role="tablist">
            <li class="nav-item" role="presentation">
                <button class="nav-link active p-2" id="em-andamento-tab" data-bs-toggle="tab" data-bs-target="#em-andamento-tab-pane"
                        type="button" role="tab" aria-controls="em-andamento-tab-pane" aria-selected="true">
                    <i class="bi bi-clock-history me-2"></i>Atendimentos em Andamento
                </button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link p-2" id="finalizados-tab" data-bs-toggle="tab" data-bs-target="#finalizados-tab-pane"
                        type="button" role="tab" aria-controls="finalizados-tab-pane" aria-selected="false">
                    <i class="bi bi-check-circle me-2"></i>Atendimentos Finalizados
                </button>
            </li>
        </ul>

        <div class="tab-content card" id="atendimentoTabsContent">

            <!-- === TAB ATENDIMENTOS EM ANDAMENTO === -->
            <div class="tab-pane fade show active" id="em-andamento-tab-pane" role="tabpanel" aria-labelledby="em-andamento-tab">
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-striped table-hover">
                            <thead>
                                <tr>
                                    <th>ID</th>
                                    <th>Paciente</th>
                                    <th>Profissional</th>
                                    <th>Tipo</th>
                                    <th>Data/Hora In√≠cio</th>
                                    <th>Status</th>
                                    <th class="text-end">A√ß√µes</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr th:each="a : ${atendimentos}" th:if="${a.status == 'EM_ANDAMENTO'}">
                                    <td th:text="${a.idAtendimento}"></td>
                                    <td th:text="${a.paciente != null ? a.paciente.nomeCompleto : '-'}"></td>
                                    <td th:text="${a.funcionario != null ? a.funcionario.nomeCompleto : '-'}"></td>
                                    <td>
                                        <span class="badge bg-info" th:text="${a.tipoEncaminhamento != null ? a.tipoEncaminhamento : '-'}"></span>
                                    </td>
                                    <td th:text="${a.dataHoraInicio != null ? #temporals.format(a.dataHoraInicio, 'dd/MM/yyyy HH:mm') : '-'}"></td>
                                    <td>
                                        <span class="badge bg-warning text-dark">
                                            <i class="bi bi-clock-history me-1"></i>Em Andamento
                                        </span>
                                    </td>
                                    <td class="text-end">
                                        <div class="btn-group btn-group-sm" role="group">
                                            <button type="button"
                                                    class="btn btn-warning"
                                                    th:onclick="'abrirModalEvolucao(' + ${a.idAtendimento} + ')'"
                                                    title="Adicionar Evolu√ß√£o">
                                                <i class="bi bi-journal-text"></i>
                                            </button>
                                            <button type="button"
                                                    class="btn btn-primary"
                                                    th:onclick="'abrirModalPrescricao(' + ${a.idAtendimento} + ')'"
                                                    title="Adicionar Prescri√ß√£o">
                                                <i class="bi bi-capsule"></i>
                                            </button>
                                            <button type="button"
                                                    class="btn btn-success"
                                                    th:onclick="'finalizarAtendimento(' + ${a.idAtendimento} + ')'"
                                                    title="Finalizar">
                                                <i class="bi bi-check-circle"></i>
                                            </button>
                                            <button type="button"
                                                    class="btn btn-info"
                                                    th:onclick="'verDetalhes(' + ${a.idAtendimento} + ')'"
                                                    title="Ver Detalhes">
                                                <i class="bi bi-eye"></i>
                                            </button>
                                            <button type="button"
                                                    class="btn btn-danger"
                                                    th:onclick="'confirmarExclusao(' + ${a.idAtendimento} + ')'"
                                                    title="Excluir">
                                                <i class="bi bi-trash"></i>
                                            </button>
                                        </div>
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- === TAB ATENDIMENTOS FINALIZADOS === -->
            <div class="tab-pane fade" id="finalizados-tab-pane" role="tabpanel" aria-labelledby="finalizados-tab">
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-striped table-hover">
                            <thead>
                                <tr>
                                    <th>ID</th>
                                    <th>Paciente</th>
                                    <th>Profissional</th>
                                    <th>Tipo</th>
                                    <th>Data/Hora In√≠cio</th>
                                    <th>Data/Hora Finaliza√ß√£o</th>
                                    <th class="text-end">A√ß√µes</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr th:each="a : ${atendimentos}" th:if="${a.status == 'FINALIZADO'}">
                                    <td th:text="${a.idAtendimento}"></td>
                                    <td th:text="${a.paciente != null ? a.paciente.nomeCompleto : '-'}"></td>
                                    <td th:text="${a.funcionario != null ? a.funcionario.nomeCompleto : '-'}"></td>
                                    <td>
                                        <span class="badge bg-info" th:text="${a.tipoEncaminhamento != null ? a.tipoEncaminhamento : '-'}"></span>
                                    </td>
                                    <td th:text="${a.dataHoraInicio != null ? #temporals.format(a.dataHoraInicio, 'dd/MM/yyyy HH:mm') : '-'}"></td>
                                    <td>
                                        <span class="text-success fw-bold" th:text="${a.dataFinalAtendimento != null ? #temporals.format(a.dataFinalAtendimento, 'dd/MM/yyyy HH:mm') : '-'}"></span>
                                    </td>
                                    <td class="text-end">
                                        <div class="btn-group btn-group-sm" role="group">
                                            <button type="button"
                                                    class="btn btn-info"
                                                    th:onclick="'verDetalhes(' + ${a.idAtendimento} + ')'"
                                                    title="Ver Detalhes">
                                                <i class="bi bi-eye"></i>
                                            </button>
                                            <button type="button"
                                                    class="btn btn-danger"
                                                    th:onclick="'confirmarExclusao(' + ${a.idAtendimento} + ')'"
                                                    title="Excluir">
                                                <i class="bi bi-trash"></i>
                                            </button>
                                        </div>
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

        </div>
    </div>
</main>


<!-- Modal de Novo Atendimento -->
<div class="modal fade" id="modalNovoAtendimento" tabindex="-1" aria-labelledby="modalNovoAtendimentoLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="modalNovoAtendimentoLabel">
                    <i class="bi bi-plus-circle me-2"></i>Iniciar Novo Atendimento
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <form method="post" th:action="@{/atendimento/iniciar}">
                <div class="modal-body">
                    <div class="mb-3">
                        <label for="idPaciente" class="form-label">Paciente *</label>
                        <select class="form-select" id="idPaciente" name="idPaciente" required>
                            <option value="">Selecione um paciente...</option>
                            <option th:each="p : ${pacientes}"
                                    th:value="${p.idPaciente}"
                                    th:text="${p.nomeCompleto}"></option>
                        </select>
                    </div>

                    <div class="mb-3">
                        <label for="tipoEncaminhamento" class="form-label">Tipo de Atendimento *</label>
                        <select class="form-select" id="tipoEncaminhamento" name="tipoEncaminhamento" required>
                            <option value="">Selecione...</option>
                            <option value="Psic√≥logo">üß† Psic√≥logo</option>
                            <option value="Fisioterapeuta">üí™ Fisioterapeuta</option>
                            <option value="Assistente Social">ü§ù Assistente Social</option>
                        </select>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                        <i class="bi bi-x-circle me-1"></i>Cancelar
                    </button>
                    <button type="submit" class="btn btn-primary">
                        <i class="bi bi-play-circle me-1"></i>Iniciar Atendimento
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>


<!-- Modal de Evolu√ß√£o -->
<div class="modal fade" id="modalEvolucao" tabindex="-1" aria-labelledby="modalEvolucaoLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="modalEvolucaoLabel">
                    <i class="bi bi-journal-text me-2"></i>Adicionar Evolu√ß√£o
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <form id="formEvolucao" method="post" action="">
                <div class="modal-body">
                    <div class="mb-3">
                        <label for="descricaoEvolucao" class="form-label">Descri√ß√£o da Evolu√ß√£o *</label>
                        <textarea class="form-control" id="descricaoEvolucao" name="descricao" rows="5" required
                                  placeholder="Descreva a evolu√ß√£o do paciente durante este atendimento..."></textarea>
                        <div class="form-text">Registre observa√ß√µes, progressos e orienta√ß√µes realizadas.</div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                        <i class="bi bi-x-circle me-1"></i>Cancelar
                    </button>
                    <button type="submit" class="btn btn-primary">
                        <i class="bi bi-save me-1"></i>Salvar Evolu√ß√£o
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>


<!-- Modal de Prescri√ß√£o -->
<div class="modal fade" id="modalPrescricao" tabindex="-1" aria-labelledby="modalPrescricaoLabel" aria-hidden="true">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="modalPrescricaoLabel"><i class="bi bi-capsule me-2"></i>Adicionar Prescri√ß√£o</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <form id="formPrescricao" method="post" action="">
        <div class="modal-body">
          <div class="mb-3">
            <label for="idEvolucaoPrescricao" class="form-label">Evolu√ß√£o *</label>
            <select id="idEvolucaoPrescricao" class="form-select" required>
              <option value="">Carregando evolu√ß√µes...</option>
            </select>
          </div>
          <div class="mb-3">
            <label for="tipoPrescricao" class="form-label">Tipo *</label>
            <select id="tipoPrescricao" class="form-select" required>
              <option value="">Selecione...</option>
              <option value="Medicamento">Medicamento</option>
              <option value="Exerc√≠cio">Exerc√≠cio</option>
              <option value="Terapia">Terapia</option>
              <option value="Dieta">Dieta</option>
              <option value="Exame">Exame</option>
              <option value="Outro">Outro</option>
            </select>
          </div>
          <div class="mb-3">
            <label for="descricaoPrescricao" class="form-label">Descri√ß√£o *</label>
            <textarea id="descricaoPrescricao" class="form-control" rows="4" required placeholder="Detalhe a prescri√ß√£o..."></textarea>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
          <button type="submit" class="btn btn-primary">Salvar</button>
        </div>
      </form>
    </div>
  </div>
</div>


<!-- Modal de Detalhes -->
<div class="modal fade" id="modalDetalhes" tabindex="-1" aria-labelledby="modalDetalhesLabel" aria-hidden="true">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="modalDetalhesLabel">
                    <i class="bi bi-eye me-2"></i>Detalhes do Atendimento
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div id="conteudoDetalhes">
                    <div class="text-center">
                        <div class="spinner-border text-primary" role="status">
                            <span class="visually-hidden">Carregando...</span>
                        </div>
                        <p class="mt-2">Carregando detalhes...</p>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                    <i class="bi bi-x-circle me-1"></i>Fechar
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Modal de Confirma√ß√£o de Finaliza√ß√£o -->
<div class="modal fade" id="modalConfirmarFinalizacao" tabindex="-1" aria-labelledby="modalConfirmarFinalizacaoLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header bg-success text-white">
                <h5 class="modal-title" id="modalConfirmarFinalizacaoLabel">
                    <i class="bi bi-check-circle me-2"></i>Confirmar Finaliza√ß√£o
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <p>Deseja finalizar este atendimento?</p>
                <p class="text-muted"><i class="bi bi-info-circle me-1"></i>Ap√≥s finalizado, n√£o ser√° mais poss√≠vel adicionar evolu√ß√µes.</p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                    <i class="bi bi-x-circle me-1"></i>Cancelar
                </button>
                <button type="button" class="btn btn-success" id="btnConfirmarFinalizacao">
                    <i class="bi bi-check-circle me-1"></i>Finalizar Atendimento
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Modal de Confirma√ß√£o de Exclus√£o -->
<div class="modal fade" id="modalConfirmarExclusaoAtendimento" tabindex="-1" aria-labelledby="modalConfirmarExclusaoAtendimentoLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header bg-danger text-white">
                <h5 class="modal-title" id="modalConfirmarExclusaoAtendimentoLabel">
                    <i class="bi bi-exclamation-triangle me-2"></i>Confirmar Exclus√£o
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <p>Tem certeza que deseja excluir este atendimento?</p>
                <p class="text-danger"><i class="bi bi-exclamation-circle me-1"></i>Esta a√ß√£o n√£o pode ser desfeita e todos os dados relacionados (evolu√ß√µes e prescri√ß√µes) ser√£o perdidos.</p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                    <i class="bi bi-x-circle me-1"></i>Cancelar
                </button>
                <button type="button" class="btn btn-danger" id="btnConfirmarExclusaoAtendimento">
                    <i class="bi bi-trash me-1"></i>Excluir Atendimento
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Modal: Gerar Relat√≥rio -->
<div class="modal fade" id="modalGerarRelatorio" tabindex="-1" aria-labelledby="modalGerarRelatorioLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h1 class="modal-title fs-5" id="modalGerarRelatorioLabel">Gerar Relat√≥rio de Atendimentos</h1>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <form id="relatorioForm">
                <div class="modal-body">
                    <!-- Op√ß√£o de formato -->
                    <div class="mb-3">
                        <label class="form-label">Formato</label>
                        <div>
                            <div class="form-check form-check-inline">
                                <input class="form-check-input" type="radio" name="formato" id="formatoPdf" value="pdf" checked>
                                <label class="form-check-label" for="formatoPdf">PDF</label>
                            </div>
                            <div class="form-check form-check-inline">
                                <input class="form-check-input" type="radio" name="formato" id="formatoCsv" value="csv">
                                <label class="form-check-label" for="formatoCsv">CSV</label>
                            </div>
                        </div>
                    </div>

                    <div class="row g-3">
                        <div class="col-6">
                            <label for="relatorioDataInicio" class="form-label">Data In√≠cio</label>
                            <input type="date" class="form-control" id="relatorioDataInicio" name="dataInicio"/>
                        </div>
                        <div class="col-6">
                            <label for="relatorioDataFim" class="form-label">Data Fim</label>
                            <input type="date" class="form-control" id="relatorioDataFim" name="dataFim"/>
                        </div>
                    </div>
                    <div class="form-text">
                        <i class="bi bi-info-circle"></i>
                        Selecione o per√≠odo dos atendimentos a serem inclu√≠dos no relat√≥rio.
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                    <button type="button" class="btn btn-primary" data-bs-dismiss="modal">Gerar</button>
                </div>
            </form>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"
        integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz"
        crossorigin="anonymous"></script>

<script>
    function abrirModalEvolucao(idAtendimento) {
        document.getElementById('formEvolucao').action = '/atendimento/' + idAtendimento + '/evolucao';
        const modal = new bootstrap.Modal(document.getElementById('modalEvolucao'));
        modal.show();
    }

    let idAtendimentoFinalizar = null;

    function finalizarAtendimento(id) {
        idAtendimentoFinalizar = id;
        const modal = new bootstrap.Modal(document.getElementById('modalConfirmarFinalizacao'));
        modal.show();
    }

    function verDetalhes(id) {
        fetch('/atendimento/' + id + '/detalhes')
            .then(response => response.json())
            .then(data => {
                let html = '<div class="row">';
                html += '<div class="col-md-6">';
                html += '<dl class="row">';
                html += '<dt class="col-sm-4">ID:</dt><dd class="col-sm-8">' + data.idAtendimento + '</dd>';
                html += '<dt class="col-sm-4">Paciente:</dt><dd class="col-sm-8">' + (data.paciente ? data.paciente.nomeCompleto : '-') + '</dd>';
                html += '<dt class="col-sm-4">Profissional:</dt><dd class="col-sm-8">' + (data.funcionario ? data.funcionario.nomeCompleto : '-') + '</dd>';
                html += '</dl>';
                html += '</div>';

                html += '<div class="col-md-6">';
                html += '<dl class="row">';
                html += '<dt class="col-sm-4">Tipo:</dt><dd class="col-sm-8"><span class="badge bg-info">' + (data.tipoEncaminhamento || '-') + '</span></dd>';
                html += '<dt class="col-sm-4">Status:</dt><dd class="col-sm-8">';
                if (data.status === 'EM_ANDAMENTO') {
                    html += '<span class="badge bg-warning text-dark"><i class="bi bi-clock-history me-1"></i>Em Andamento</span>';
                } else if (data.status === 'FINALIZADO') {
                    html += '<span class="badge bg-success"><i class="bi bi-check-circle me-1"></i>Finalizado</span>';
                } else {
                    html += '<span class="badge bg-secondary">' + (data.status || '-') + '</span>';
                }
                html += '</dd>';

                if (data.dataHoraInicio) {
                    html += '<dt class="col-sm-4">In√≠cio:</dt><dd class="col-sm-8">' + formatarDataHora(data.dataHoraInicio) + '</dd>';
                }
                if (data.dataHoraFim) {
                    html += '<dt class="col-sm-4">Fim:</dt><dd class="col-sm-8">' + formatarDataHora(data.dataHoraFim) + '</dd>';
                }
                if (data.dataFinalAtendimento) {
                    html += '<dt class="col-sm-4">Finalizado em:</dt><dd class="col-sm-8"><strong class="text-success">' + formatarDataHora(data.dataFinalAtendimento) + '</strong></dd>';
                }
                html += '</dl>';
                html += '</div>';
                html += '</div>';

                if (data.evolucoes && data.evolucoes.length > 0) {
                    html += '<hr class="my-4">';
                    html += '<h6 class="mb-3"><i class="bi bi-journal-text me-2"></i>Evolu√ß√µes e Prescri√ß√µes</h6>';
                    data.evolucoes.forEach(ev => {
                        html += '<div class="card mb-3 border-primary">';
                        html += '<div class="card-body">';
                        html += '<h6 class="card-subtitle mb-2 text-muted">';
                        html += '<i class="bi bi-calendar-event me-1"></i>' + (ev.dataHoraRegistro ? formatarDataHora(ev.dataHoraRegistro) : '-') + ' ';
                        html += '<span class="badge bg-secondary">Evolu√ß√£o #' + ev.idEvolucao + '</span>';
                        html += '</h6>';
                        html += '<p class="card-text"><strong>Descri√ß√£o:</strong> ' + (ev.descricao || '-') + '</p>';

                        if (ev.prescricoes && ev.prescricoes.length > 0) {
                            html += '<hr class="my-2">';
                            html += '<h6 class="mb-2"><i class="bi bi-prescription2 me-1"></i>Prescri√ß√µes</h6>';
                            ev.prescricoes.forEach(p => {
                                html += '<div class="alert alert-success py-2 mb-2" role="alert">';
                                html += '<div class="d-flex justify-content-between align-items-center">';
                                html += '<span class="badge bg-primary me-2">' + (p.tipo || 'Tipo n√£o informado') + '</span>';
                                html += '<small class="text-muted">#' + p.idPrescricao + '</small>';
                                html += '</div>';
                                html += '<div class="mt-1"><strong>Descri√ß√£o:</strong> ' + (p.descricao || '-') + '</div>';
                                html += '</div>';
                            });
                        } else {
                            html += '<p class="text-muted mb-0"><i class="bi bi-info-circle me-1"></i>Sem prescri√ß√µes para esta evolu√ß√£o.</p>';
                        }

                        html += '</div>'; // card-body
                        html += '</div>'; // card
                    });
                } else {
                    html += '<hr class="my-4">';
                    html += '<div class="alert alert-info" role="alert">';
                    html += '<i class="bi bi-info-circle me-2"></i>Nenhuma evolu√ß√£o registrada ainda.';
                    html += '</div>';
                }

                html += '</div>';

                document.getElementById('conteudoDetalhes').innerHTML = html;
                const modal = new bootstrap.Modal(document.getElementById('modalDetalhes'));
                modal.show();
            })
            .catch(error => {
                alert('Erro ao carregar detalhes do atendimento');
                console.error('Erro:', error);
            });
    }

    let idAtendimentoExcluir = null;

    function confirmarExclusao(id) {
        idAtendimentoExcluir = id;
        const modal = new bootstrap.Modal(document.getElementById('modalConfirmarExclusaoAtendimento'));
        modal.show();
    }

    // Event listeners para os bot√µes de confirma√ß√£o
    document.addEventListener('DOMContentLoaded', function() {
        // Bot√£o de confirmar finaliza√ß√£o
        document.getElementById('btnConfirmarFinalizacao').addEventListener('click', function() {
            if (idAtendimentoFinalizar) {
                const form = document.createElement('form');
                form.method = 'POST';
                form.action = '/atendimento/' + idAtendimentoFinalizar + '/finalizar';
                document.body.appendChild(form);
                form.submit();
            }
        });

        // Bot√£o de confirmar exclus√£o
        document.getElementById('btnConfirmarExclusaoAtendimento').addEventListener('click', function() {
            if (idAtendimentoExcluir) {
                window.location.href = '/atendimento/' + idAtendimentoExcluir + '/deletar';
            }
        });
    });

    function formatarDataHora(dataHora) {
        const data = new Date(dataHora);
        return data.toLocaleString('pt-BR', {
            day: '2-digit',
            month: '2-digit',
            year: 'numeric',
            hour: '2-digit',
            minute: '2-digit'
        });
    }

    function abrirModalPrescricao(idAtendimento){
      const evolucaoSelect = document.getElementById('idEvolucaoPrescricao');
      evolucaoSelect.innerHTML = '<option value="">Carregando evolu√ß√µes...</option>';
      fetch('/atendimento/' + idAtendimento + '/detalhes')
        .then(r=>r.json())
        .then(data=>{
          evolucaoSelect.innerHTML = '<option value="">Selecione uma evolu√ß√£o...</option>';
          if(data.evolucoes && data.evolucoes.length){
            data.evolucoes.forEach(ev=>{
              const opt=document.createElement('option');
              opt.value=ev.idEvolucao;
              opt.textContent='Evolu√ß√£o #' + ev.idEvolucao + ' - ' + (ev.dataHoraRegistro? formatarDataHora(ev.dataHoraRegistro):'');
              evolucaoSelect.appendChild(opt);
            });
          } else {
            evolucaoSelect.innerHTML = '<option value="">Sem evolu√ß√µes</option>';
          }
        })
        .catch(()=>{evolucaoSelect.innerHTML='<option value="">Erro ao carregar</option>'});

      const form = document.getElementById('formPrescricao');
      form.onsubmit = function(e){
        e.preventDefault();
        const idEvolucao = evolucaoSelect.value;
        const tipo = document.getElementById('tipoPrescricao').value;
        const descricao = document.getElementById('descricaoPrescricao').value;
        if(!idEvolucao || !tipo || !descricao){
          alert('Preencha todos os campos.');
          return;
        }
        const f=document.createElement('form');
        f.method='POST';
        f.action='/atendimento/evolucao/' + idEvolucao + '/prescricao';
        const hTipo=document.createElement('input'); hTipo.type='hidden'; hTipo.name='tipo'; hTipo.value=tipo; f.appendChild(hTipo);
        const hDesc=document.createElement('input'); hDesc.type='hidden'; hDesc.name='descricao'; hDesc.value=descricao; f.appendChild(hDesc);
        document.body.appendChild(f);
        f.submit();
      };
      const modal=new bootstrap.Modal(document.getElementById('modalPrescricao'));
      modal.show();
    }
</script>

</body>
</html>

        .modal-content {
            background-color: #fefefe;
            margin: 5% auto;
            padding: 20px;
            border: 1px solid #888;
            border-radius: 8px;
            width: 90%;
            max-width: 600px;
            position: relative;
        }

        .close {
            color: #aaa;
            float: right;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
        }

        .close:hover,
        .close:focus {
            color: black;
        }

        .form-group {
            margin-bottom: 15px;
        }

        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
        }

        .form-group input,
        .form-group select,
        .form-group textarea {
            width: 100%;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
            box-sizing: border-box;
        }

        .btn-primary, .btn-secondary, .btn-edit, .btn-delete, .btn-success, .btn-info {
            padding: 8px 15px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            margin-left: 5px;
        }

        .btn-primary {
            background-color: #007bff;
            color: white;
        }

        .btn-secondary {
            background-color: #6c757d;
            color: white;
        }

        .btn-edit {
            background-color: #ffc107;
            color: black;
        }

        .btn-delete {
            background-color: #dc3545;
            color: white;
        }

        .btn-success {
            background-color: #28a745;
            color: white;
        }

        .btn-info {
            background-color: #17a2b8;
            color: white;
        }

        .alert {
            padding: 12px 20px;
            border-radius: 4px;
            margin-bottom: 20px;
        }

        .alert-success {
            background-color: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .alert-danger {
            background-color: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }

        .table-container {
            overflow-x: auto;
        }

        .data-table {
            width: 100%;
            border-collapse: collapse;
            background-color: white;
        }

        .data-table th,
        .data-table td {

