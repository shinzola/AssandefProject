<!DOCTYPE html>
<html lang="pt-br" xmlns:th="http://www.thymeleaf.org">
<head th:replace="~{fragments/base :: headPadrao('Gestão de Pacientes')}">
</head>

<body>

<header th:replace="~{fragments/base :: cabecalho}"></header>

<div class="container mt-3" th:if="${(msg != null and !#strings.isEmpty(msg)) or (erro != null and !#strings.isEmpty(erro))}">
    <div class="alert alert-success alert-dismissible fade show" role="alert"
         th:if="${msg != null and !#strings.isEmpty(msg)}">
        <span th:text="${msg}">Ação realizada com sucesso!</span>
        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
    </div>

    <div class="alert alert-danger alert-dismissible fade show" role="alert"
         th:if="${erro != null and !#strings.isEmpty(erro)}">
        <span th:text="${erro}">Ocorreu um erro</span>
        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
    </div>
</div>

<main class="main-page">
    <div class="container-fluid">
        <div class="page-header">
            <h1 class="page-title">Gestão de Pacientes</h1>
            <div class="page-actions">
                <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#modalPaciente">
                    <i class="bi bi-person-plus me-2"></i>Novo Paciente
                </button>
            </div>
        </div>

        <!-- Barra de Busca -->
        <div class="card mt-4 mb-3">
            <div class="card-body">
                <form method="get" th:action="@{/pacientes}" class="row g-3">
                    <div class="col-md-10">
                        <input type="text" class="form-control" name="busca"
                               placeholder="Buscar por nome ou CPF..."
                               th:value="${param.busca}">
                    </div>
                    <div class="col-md-2">
                        <div class="btn-group w-100" role="group">
                            <button type="submit" class="btn btn-primary">
                                <i class="bi bi-search me-1"></i>Buscar
                            </button>
                            <a th:href="@{/pacientes}" class="btn btn-secondary">
                                <i class="bi bi-x-circle"></i>
                            </a>
                        </div>
                    </div>
                </form>
            </div>
        </div>

        <!-- Tabela de Pacientes -->
        <div class="card">
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-striped table-hover">
                        <thead>
                            <tr>
                                <th>ID</th>
                                <th>Nome Completo</th>
                                <th>CPF</th>
                                <th>Data Nascimento</th>
                                <th>Telefone</th>
                                <th class="text-end">Ações</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr th:if="${pacientes.isEmpty()}">
                                <td colspan="6" class="text-center text-muted">
                                    <i class="bi bi-inbox fs-1"></i>
                                    <p>Nenhum paciente cadastrado</p>
                                </td>
                            </tr>
                            <tr th:each="p : ${pacientes}">
                                <td th:text="${p.idPaciente}"></td>
                                <td th:text="${p.nomeCompleto}"></td>
                                <td th:text="${p.cpf != null ? p.cpf : '-'}"></td>
                                <td th:text="${p.dataNascimento != null ? #temporals.format(p.dataNascimento, 'dd/MM/yyyy') : '-'}"></td>
                                <td th:text="${p.telefonePrincipal != null ? p.telefonePrincipal : '-'}"></td>
                                <td class="text-end">
                                    <div class="btn-group btn-group-sm" role="group">
                                        <button type="button" class="btn btn-warning"
                                                th:attr="onclick='editarPaciente(' + ${p.idPaciente} + ')'"
                                                title="Editar">
                                            <i class="bi bi-pencil"></i>
                                        </button>
                                        <button type="button" class="btn btn-danger"
                                                th:attr="onclick='confirmarExclusao(' + ${p.idPaciente} + ', \'' + ${p.nomeCompleto} + '\')'"
                                                title="Excluir">
                                            <i class="bi bi-trash"></i>
                                        </button>
                                    </div>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</main>

<!-- Modal de Cadastro/Edição de Paciente -->
<div class="modal fade" id="modalPaciente" tabindex="-1" aria-labelledby="modalPacienteLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="modalPacienteLabel">
                    <i class="bi bi-person-plus me-2"></i><span id="tituloModal">Novo Paciente</span>
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <form id="formPaciente" method="post" th:action="@{/pacientes/salvar}">
                <div class="modal-body">
                    <input type="hidden" id="idPaciente" name="idPaciente">

                    <div class="row">
                        <div class="col-12 mb-3">
                            <label for="nomeCompleto" class="form-label">Nome Completo *</label>
                            <input type="text" class="form-control" id="nomeCompleto" name="nomeCompleto" required>
                        </div>
                    </div>

                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="cpf" class="form-label">CPF</label>
                            <input type="text" class="form-control" id="cpf" name="cpf" maxlength="11" placeholder="Apenas números">
                        </div>
                        <div class="col-md-6 mb-3">
                            <label for="rg" class="form-label">RG</label>
                            <input type="text" class="form-control" id="rg" name="rg" maxlength="20">
                        </div>
                    </div>

                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="nSus" class="form-label">Número SUS</label>
                            <input type="text" class="form-control" id="nSus" name="nSus" maxlength="15">
                        </div>
                        <div class="col-md-6 mb-3">
                            <label for="dataNascimento" class="form-label">Data de Nascimento</label>
                            <input type="date" class="form-control" id="dataNascimento" name="dataNascimento">
                        </div>
                    </div>

                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="sexo" class="form-label">Sexo</label>
                            <select class="form-select" id="sexo" name="sexo">
                                <option value="">Selecione...</option>
                                <option value="Masculino">Masculino</option>
                                <option value="Feminino">Feminino</option>
                                <option value="Outro">Outro</option>
                            </select>
                        </div>
                    </div>

                    <div class="row">
                        <div class="col-12 mb-3">
                            <label for="endereco" class="form-label">Endereço</label>
                            <textarea class="form-control" id="endereco" name="endereco" rows="2"></textarea>
                        </div>
                    </div>

                    <!-- Seção de Telefones Dinâmicos -->
                    <div class="row">
                        <div class="col-12 mb-2">
                            <hr>
                            <label class="form-label fw-bold">
                                <i class="bi bi-telephone-fill me-2"></i>Telefones para Contato
                            </label>
                        </div>
                    </div>

                    <div id="containerTelefones" class="mb-3">
                        <!-- Telefones serão adicionados aqui dinamicamente -->
                    </div>

                    <div class="row mb-3">
                        <div class="col-12">
                            <button type="button" class="btn btn-sm btn-outline-primary" onclick="adicionarCampoTelefone()">
                                <i class="bi bi-plus-circle me-1"></i>Adicionar Telefone
                            </button>
                        </div>
                    </div>

                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="nomeResponsavel" class="form-label">Nome do Responsável</label>
                            <input type="text" class="form-control" id="nomeResponsavel" name="nomeResponsavel">
                        </div>
                        <div class="col-md-6 mb-3">
                            <label for="contatoResponsavel" class="form-label">Contato do Responsável</label>
                            <input type="text" class="form-control" id="contatoResponsavel" name="contatoResponsavel">
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                        <i class="bi bi-x-circle me-1"></i>Cancelar
                    </button>
                    <button type="submit" class="btn btn-primary">
                        <i class="bi bi-save me-1"></i>Salvar
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Modal de Confirmação de Exclusão -->
<div class="modal fade" id="modalConfirmarExclusao" tabindex="-1" aria-labelledby="modalConfirmarExclusaoLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header bg-danger text-white">
                <h5 class="modal-title" id="modalConfirmarExclusaoLabel">
                    <i class="bi bi-exclamation-triangle me-2"></i>Confirmar Exclusão
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <p>Tem certeza que deseja excluir o paciente <strong id="nomePacienteExcluir"></strong>?</p>
                <p class="text-danger"><i class="bi bi-exclamation-circle me-1"></i>Esta ação não pode ser desfeita e todos os dados relacionados serão perdidos.</p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                    <i class="bi bi-x-circle me-1"></i>Cancelar
                </button>
                <button type="button" class="btn btn-danger" id="btnConfirmarExclusao">
                    <i class="bi bi-trash me-1"></i>Excluir
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Modal de Aviso - Não Pode Excluir -->
<div class="modal fade" id="modalNaoPodeExcluir" tabindex="-1" aria-labelledby="modalNaoPodeExcluirLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content border-warning">
            <div class="modal-header bg-warning text-dark">
                <h5 class="modal-title fw-bold" id="modalNaoPodeExcluirLabel">
                    <i class="bi bi-exclamation-triangle-fill me-2"></i>Exclusão Não Permitida
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="mb-3">
                    <h6 class="fw-bold text-dark" id="nomePacienteNaoPodeExcluir"></h6>
                </div>
                <div class="alert alert-warning d-flex align-items-start mb-0" role="alert">
                    <i class="bi bi-info-circle-fill me-3 fs-4 flex-shrink-0"></i>
                    <div>
                        <p class="mb-0 fw-semibold" id="mensagemNaoPodeExcluir"></p>
                    </div>
                </div>
            </div>
            <div class="modal-footer bg-light">
                <button type="button" class="btn btn-primary px-4" data-bs-dismiss="modal">
                    <i class="bi bi-check-circle me-2"></i>Entendi
                </button>
            </div>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"
        integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz"
        crossorigin="anonymous"></script>

<script>
    let idPacienteExcluir = null;
    let contadorTelefones = 0;
    let telefonesParaExcluir = []; // IDs de telefones a serem excluídos

    function adicionarCampoTelefone(numero = '', descricao = '', idTelefone = null) {
        contadorTelefones++;
        const container = document.getElementById('containerTelefones');

        const div = document.createElement('div');
        div.className = 'row mb-2 telefone-item';
        div.id = 'telefone-' + contadorTelefones;
        div.dataset.idTelefone = idTelefone || '';

        div.innerHTML = `
            <div class="col-md-5">
                <input type="text" class="form-control form-control-sm"
                       name="telefones[${contadorTelefones}].numero"
                       value="${numero}"
                       placeholder="(99) 99999-9999">
            </div>
            <div class="col-md-5">
                <input type="text" class="form-control form-control-sm"
                       name="telefones[${contadorTelefones}].descricao"
                       value="${descricao}"
                       placeholder="Ex: Celular, Fixo, Filho, Responsável...">
            </div>
            <div class="col-md-2">
                <button type="button" class="btn btn-sm btn-danger" onclick="removerCampoTelefone(${contadorTelefones}, '${idTelefone || ''}')">
                    <i class="bi bi-trash"></i>
                </button>
            </div>
        `;

        container.appendChild(div);
        console.log('Telefone adicionado:', {contador: contadorTelefones, numero, descricao, idTelefone});
    }

    function removerCampoTelefone(contador, idTelefone) {
        const elemento = document.getElementById('telefone-' + contador);
        if (elemento) {
            // Se tem ID, marca para exclusão no backend
            if (idTelefone && idTelefone !== '') {
                telefonesParaExcluir.push(idTelefone);
                console.log('Telefone marcado para exclusão:', idTelefone);

                // Adiciona campo hidden para enviar ao backend
                const input = document.createElement('input');
                input.type = 'hidden';
                input.name = 'telefonesExcluir';
                input.value = idTelefone;
                document.getElementById('formPaciente').appendChild(input);
            }

            elemento.remove();
            console.log('Telefone removido:', contador);
        }
    }

    function limparFormulario() {
        console.log('Limpando formulário');
        document.getElementById('tituloModal').textContent = 'Novo Paciente';
        document.getElementById('formPaciente').reset();
        document.getElementById('idPaciente').value = '';

        // Limpa telefones
        document.getElementById('containerTelefones').innerHTML = '';
        contadorTelefones = 0;
        telefonesParaExcluir = [];

        // Adiciona um telefone vazio para começar
        adicionarCampoTelefone();
    }

    function editarPaciente(id) {
        console.log('=== INICIANDO EDIÇÃO ===');
        console.log('ID do paciente:', id);
        console.log('URL da requisição:', '/pacientes/' + id);

        fetch('/pacientes/' + id)
            .then(response => {
                console.log('Status da resposta:', response.status);
                console.log('Response OK?', response.ok);

                if (!response.ok) {
                    throw new Error('HTTP ' + response.status);
                }

                return response.text(); // Primeiro como texto para ver o que vem
            })
            .then(text => {
                console.log('Resposta recebida (texto):', text);

                try {
                    const data = JSON.parse(text);
                    console.log('=== DADOS DO PACIENTE ===');
                    console.log('JSON parseado:', data);
                    console.log('nSus do JSON:', data.nSus);
                    console.log('telefones do JSON:', data.telefones);

                    document.getElementById('tituloModal').textContent = 'Editar Paciente';
                    document.getElementById('idPaciente').value = data.idPaciente || '';
                    document.getElementById('nomeCompleto').value = data.nomeCompleto || '';
                    document.getElementById('cpf').value = data.cpf || '';
                    document.getElementById('rg').value = data.rg || '';

                    // nSus com log detalhado
                    const nSusValue = data.nSus || '';
                    console.log('Setando nSus para:', nSusValue);
                    document.getElementById('nSus').value = nSusValue;

                    document.getElementById('dataNascimento').value = data.dataNascimento || '';
                    document.getElementById('sexo').value = data.sexo || '';
                    document.getElementById('endereco').value = data.endereco || '';
                    document.getElementById('nomeResponsavel').value = data.nomeResponsavel || '';
                    document.getElementById('contatoResponsavel').value = data.contatoResponsavel || '';

                    // Limpa telefones existentes
                    document.getElementById('containerTelefones').innerHTML = '';
                    contadorTelefones = 0;
                    telefonesParaExcluir = [];

                    // Preencher telefones dinamicamente
                    if (data.telefones && data.telefones.length > 0) {
                        console.log('Carregando', data.telefones.length, 'telefone(s)');
                        data.telefones.forEach(tel => {
                            adicionarCampoTelefone(tel.numero, tel.descricao || '', tel.id);
                        });
                    } else {
                        // Se não tem telefones, adiciona um vazio
                        console.log('Nenhum telefone encontrado, adicionando campo vazio');
                        adicionarCampoTelefone();
                    }

                    console.log('Formulário preenchido, abrindo modal...');

                    const modal = new bootstrap.Modal(document.getElementById('modalPaciente'));
                    modal.show();

                    console.log('Modal aberto com sucesso!');
                } catch (jsonError) {
                    console.error('Erro ao fazer parse do JSON:', jsonError);
                    console.error('Texto recebido:', text);
                    alert('Erro ao processar resposta do servidor: ' + jsonError.message);
                }
            })
            .catch(error => {
                console.error('Erro na requisição:', error);
                alert('Erro ao carregar dados do paciente: ' + error.message);
            });
    }

    function confirmarExclusao(id, nome) {
        console.log('Tentativa de excluir paciente ID:', id);

        // SEMPRE mostra o modal de exclusão não permitida - SEM VERIFICAÇÃO NO SERVIDOR
        document.getElementById('nomePacienteNaoPodeExcluir').textContent = 'Paciente: ' + nome;
        document.getElementById('mensagemNaoPodeExcluir').textContent =
            'Não é possível excluir este paciente. Os registros de pacientes devem ser mantidos para histórico médico e integridade do sistema.';

        const modal = new bootstrap.Modal(document.getElementById('modalNaoPodeExcluir'));
        modal.show();
    }

    // Event listeners
    document.addEventListener('DOMContentLoaded', function() {
        console.log('Página de pacientes carregada - JavaScript ativo');

        // Adiciona telefone vazio ao abrir modal para novo paciente
        const btnNovoPaciente = document.querySelector('[data-bs-target="#modalPaciente"]');
        if (btnNovoPaciente) {
            btnNovoPaciente.addEventListener('click', function() {
                // Limpa e adiciona um telefone vazio
                setTimeout(() => {
                    if (document.getElementById('containerTelefones').children.length === 0) {
                        adicionarCampoTelefone();
                    }
                }, 100);
            });
        }

        // Exclusão de pacientes BLOQUEADA - event listener removido
        // Os pacientes não podem ser excluídos para manter histórico médico

        // Validação antes de enviar o formulário
        const formPaciente = document.getElementById('formPaciente');
        if (formPaciente) {
            formPaciente.addEventListener('submit', function(e) {
                console.log('Validando formulário antes de enviar...');

                // Remove campos de telefone vazios
                const camposTelefone = document.querySelectorAll('#containerTelefones .telefone-item');
                let removidos = 0;

                camposTelefone.forEach(item => {
                    const inputNumero = item.querySelector('input[name*=".numero"]');
                    const inputDescricao = item.querySelector('input[name*=".descricao"]');

                    const numero = inputNumero ? inputNumero.value.trim() : '';
                    const descricao = inputDescricao ? inputDescricao.value.trim() : '';

                    // Se AMBOS estão vazios, remove o item
                    if (!numero && !descricao) {
                        console.log('Removendo telefone vazio antes de enviar');
                        item.remove();
                        removidos++;
                    }
                    // Se apenas um está preenchido, mostra erro
                    else if (!numero || !descricao) {
                        e.preventDefault();
                        alert('Por favor, preencha tanto o número quanto a descrição do telefone, ou remova o campo vazio.');
                        if (!numero) inputNumero.focus();
                        else inputDescricao.focus();
                        return false;
                    }
                });

                console.log('Telefones vazios removidos: ' + removidos);
            });
        }

        // Limpar ao fechar modal
        const modalPaciente = document.getElementById('modalPaciente');
        if (modalPaciente) {
            modalPaciente.addEventListener('hidden.bs.modal', function() {
                console.log('Modal fechado, limpando formulário');
                limparFormulario();
            });
        }
    });
</script>

</body>
</html>
