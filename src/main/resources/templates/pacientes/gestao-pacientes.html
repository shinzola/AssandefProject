<!DOCTYPE html>
<html lang="pt-br" xmlns:th="http://www.thymeleaf.org">
<head th:replace="~{fragments/base :: headPadrao('Gestão de Pacientes')}">
</head>

<body>

<header th:replace="~{fragments/base :: cabecalho}"></header>

<div class="container mt-3" th:if="${(msg != null and !#strings.isEmpty(msg)) or (erro != null and !#strings.isEmpty(erro))}">
    <div class="alert alert-success alert-dismissible fade show" role="alert"
         th:if="${msg != null and !#strings.isEmpty(msg)}">
        <span th:text="${msg}">Ação realizada com sucesso!</span>
        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
    </div>

    <div class="alert alert-danger alert-dismissible fade show" role="alert"
         th:if="${erro != null and !#strings.isEmpty(erro)}">
        <span th:text="${erro}">Ocorreu um erro</span>
        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
    </div>
</div>

<main class="main-page">
    <div class="container-fluid">
        <div class="page-header">
            <h1 class="page-title">Gestão de Pacientes</h1>
            <div class="page-actions">
                <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#modalPaciente">
                    <i class="bi bi-person-plus me-2"></i>Novo Paciente
                </button>
            </div>
        </div>

        <!-- Barra de Busca -->
        <div class="card mt-4 mb-3">
            <div class="card-body">
                <form method="get" th:action="@{/pacientes}" class="row g-3">
                    <div class="col-md-10">
                        <input type="text" class="form-control" name="busca"
                               placeholder="Buscar por nome ou CPF..."
                               th:value="${param.busca}">
                    </div>
                    <div class="col-md-2">
                        <div class="btn-group w-100" role="group">
                            <button type="submit" class="btn btn-primary">
                                <i class="bi bi-search me-1"></i>Buscar
                            </button>
                            <a th:href="@{/pacientes}" class="btn btn-secondary">
                                <i class="bi bi-x-circle"></i>
                            </a>
                        </div>
                    </div>
                </form>
            </div>
        </div>

        <!-- Tabela de Pacientes -->
        <div class="card">
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-striped table-hover">
                        <thead>
                            <tr>
                                <th>ID</th>
                                <th>Nome Completo</th>
                                <th>CPF</th>
                                <th>Data Nascimento</th>
                                <th>Telefone</th>
                                <th class="text-end">Ações</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr th:if="${pacientes.isEmpty()}">
                                <td colspan="6" class="text-center text-muted">
                                    <i class="bi bi-inbox fs-1"></i>
                                    <p>Nenhum paciente cadastrado</p>
                                </td>
                            </tr>
                            <tr th:each="p : ${pacientes}">
                                <td th:text="${p.idPaciente}"></td>
                                <td th:text="${p.nomeCompleto}"></td>
                                <td th:text="${p.cpf != null ? p.cpf : '-'}"></td>
                                <td th:text="${p.dataNascimento != null ? #temporals.format(p.dataNascimento, 'dd/MM/yyyy') : '-'}"></td>
                                <td th:text="${p.telefonePrincipal != null ? p.telefonePrincipal : '-'}"></td>
                                <td class="text-end">
                                    <div class="btn-group btn-group-sm" role="group">
                                        <button type="button" class="btn btn-warning"
                                                th:attr="onclick='editarPaciente(' + ${p.idPaciente} + ')'"
                                                title="Editar">
                                            <i class="bi bi-pencil"></i>
                                        </button>
                                        <button type="button" class="btn btn-danger"
                                                th:attr="onclick='confirmarExclusao(' + ${p.idPaciente} + ', \'' + ${p.nomeCompleto} + '\')'"
                                                title="Excluir">
                                            <i class="bi bi-trash"></i>
                                        </button>
                                    </div>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</main>

<!-- Modal de Cadastro/Edição de Paciente -->
<div class="modal fade" id="modalPaciente" tabindex="-1" aria-labelledby="modalPacienteLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="modalPacienteLabel">
                    <i class="bi bi-person-plus me-2"></i><span id="tituloModal">Novo Paciente</span>
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <form id="formPaciente" method="post" th:action="@{/pacientes/salvar}">
                <div class="modal-body">
                    <input type="hidden" id="idPaciente" name="idPaciente">

                    <div class="row">
                        <div class="col-12 mb-3">
                            <label for="nomeCompleto" class="form-label">Nome Completo *</label>
                            <input type="text" class="form-control" id="nomeCompleto" name="nomeCompleto" required>
                        </div>
                    </div>

                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="cpf" class="form-label">CPF</label>
                            <input type="text" class="form-control" id="cpf" name="cpf" maxlength="11" placeholder="Apenas números">
                        </div>
                        <div class="col-md-6 mb-3">
                            <label for="rg" class="form-label">RG</label>
                            <input type="text" class="form-control" id="rg" name="rg" maxlength="20">
                        </div>
                    </div>

                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="nSus" class="form-label">Número SUS</label>
                            <input type="text" class="form-control" id="nSus" name="nSus" maxlength="15">
                        </div>
                        <div class="col-md-6 mb-3">
                            <label for="dataNascimento" class="form-label">Data de Nascimento</label>
                            <input type="date" class="form-control" id="dataNascimento" name="dataNascimento">
                        </div>
                    </div>

                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="telefonePrincipal" class="form-label">Telefone</label>
                            <input type="text" class="form-control" id="telefonePrincipal" name="telefonePrincipal" placeholder="(99) 99999-9999">
                        </div>
                        <div class="col-md-6 mb-3">
                            <label for="sexo" class="form-label">Sexo</label>
                            <select class="form-select" id="sexo" name="sexo">
                                <option value="">Selecione...</option>
                                <option value="Masculino">Masculino</option>
                                <option value="Feminino">Feminino</option>
                                <option value="Outro">Outro</option>
                            </select>
                        </div>
                    </div>

                    <div class="row">
                        <div class="col-12 mb-3">
                            <label for="endereco" class="form-label">Endereço</label>
                            <textarea class="form-control" id="endereco" name="endereco" rows="2"></textarea>
                        </div>
                    </div>

                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="nomeResponsavel" class="form-label">Nome do Responsável</label>
                            <input type="text" class="form-control" id="nomeResponsavel" name="nomeResponsavel">
                        </div>
                        <div class="col-md-6 mb-3">
                            <label for="contatoResponsavel" class="form-label">Contato do Responsável</label>
                            <input type="text" class="form-control" id="contatoResponsavel" name="contatoResponsavel">
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                        <i class="bi bi-x-circle me-1"></i>Cancelar
                    </button>
                    <button type="submit" class="btn btn-primary">
                        <i class="bi bi-save me-1"></i>Salvar
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Modal de Confirmação de Exclusão -->
<div class="modal fade" id="modalConfirmarExclusao" tabindex="-1" aria-labelledby="modalConfirmarExclusaoLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header bg-danger text-white">
                <h5 class="modal-title" id="modalConfirmarExclusaoLabel">
                    <i class="bi bi-exclamation-triangle me-2"></i>Confirmar Exclusão
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <p>Tem certeza que deseja excluir o paciente <strong id="nomePacienteExcluir"></strong>?</p>
                <p class="text-danger"><i class="bi bi-exclamation-circle me-1"></i>Esta ação não pode ser desfeita e todos os dados relacionados serão perdidos.</p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                    <i class="bi bi-x-circle me-1"></i>Cancelar
                </button>
                <button type="button" class="btn btn-danger" id="btnConfirmarExclusao">
                    <i class="bi bi-trash me-1"></i>Excluir
                </button>
            </div>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"
        integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz"
        crossorigin="anonymous"></script>

<script>
    let idPacienteExcluir = null;

    function limparFormulario() {
        console.log('Limpando formulário');
        document.getElementById('tituloModal').textContent = 'Novo Paciente';
        document.getElementById('formPaciente').reset();
        document.getElementById('idPaciente').value = '';
    }

    function editarPaciente(id) {
        console.log('=== INICIANDO EDIÇÃO ===');
        console.log('ID do paciente:', id);
        console.log('URL da requisição:', '/pacientes/' + id);

        fetch('/pacientes/' + id)
            .then(response => {
                console.log('Status da resposta:', response.status);
                console.log('Response OK?', response.ok);

                if (!response.ok) {
                    throw new Error('HTTP ' + response.status);
                }

                return response.text(); // Primeiro como texto para ver o que vem
            })
            .then(text => {
                console.log('Resposta recebida (texto):', text);

                try {
                    const data = JSON.parse(text);
                    console.log('=== DADOS DO PACIENTE ===');
                    console.log('JSON parseado:', data);
                    console.log('nSus do JSON:', data.nSus);
                    console.log('telefones do JSON:', data.telefones);

                    document.getElementById('tituloModal').textContent = 'Editar Paciente';
                    document.getElementById('idPaciente').value = data.idPaciente || '';
                    document.getElementById('nomeCompleto').value = data.nomeCompleto || '';
                    document.getElementById('cpf').value = data.cpf || '';
                    document.getElementById('rg').value = data.rg || '';

                    // nSus com log detalhado
                    const nSusValue = data.nSus || '';
                    console.log('Setando nSus para:', nSusValue);
                    document.getElementById('nSus').value = nSusValue;

                    document.getElementById('dataNascimento').value = data.dataNascimento || '';
                    document.getElementById('sexo').value = data.sexo || '';
                    document.getElementById('endereco').value = data.endereco || '';
                    document.getElementById('nomeResponsavel').value = data.nomeResponsavel || '';
                    document.getElementById('contatoResponsavel').value = data.contatoResponsavel || '';

                    // telefone principal: primeiro telefone, se existir
                    const tel = (data.telefones && data.telefones.length > 0) ? data.telefones[0].numero : '';
                    console.log('Setando telefone para:', tel);
                    const telInput = document.getElementById('telefonePrincipal');
                    if (telInput) {
                        telInput.value = tel;
                        console.log('Telefone setado no campo:', telInput.value);
                    }

                    console.log('Formulário preenchido, abrindo modal...');

                    const modal = new bootstrap.Modal(document.getElementById('modalPaciente'));
                    modal.show();

                    console.log('Modal aberto com sucesso!');
                } catch (jsonError) {
                    console.error('Erro ao fazer parse do JSON:', jsonError);
                    console.error('Texto recebido:', text);
                    alert('Erro ao processar resposta do servidor: ' + jsonError.message);
                }
            })
            .catch(error => {
                console.error('Erro na requisição:', error);
                alert('Erro ao carregar dados do paciente: ' + error.message);
            });
    }

    function confirmarExclusao(id, nome) {
        idPacienteExcluir = id;
        document.getElementById('nomePacienteExcluir').textContent = nome;
        const modal = new bootstrap.Modal(document.getElementById('modalConfirmarExclusao'));
        modal.show();
    }

    // Event listeners
    document.addEventListener('DOMContentLoaded', function() {
        console.log('Página de pacientes carregada - JavaScript ativo');

        // Confirmar exclusão
        const btnConfirmarExclusao = document.getElementById('btnConfirmarExclusao');
        if (btnConfirmarExclusao) {
            btnConfirmarExclusao.addEventListener('click', function() {
                if (idPacienteExcluir) {
                    window.location.href = '/pacientes/deletar/' + idPacienteExcluir;
                }
            });
        }

        // Limpar ao fechar modal
        const modalPaciente = document.getElementById('modalPaciente');
        if (modalPaciente) {
            modalPaciente.addEventListener('hidden.bs.modal', function() {
                console.log('Modal fechado, limpando formulário');
                limparFormulario();
            });
        }
    });
</script>

</body>
</html>
