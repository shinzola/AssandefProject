<!DOCTYPE html>
<html lang="pt-br" xmlns:th="http://www.thymeleaf.org">
<head th:replace="~{fragments/base :: headPadrao('Estoque')}"></head>
<body>

<header th:replace="~{fragments/base :: cabecalho}"></header>

<!-- FLASH MESSAGES -->
<div class="container mt-3" th:if="${(msg != null and !#strings.isEmpty(msg)) or (erro != null and !#strings.isEmpty(erro))}">
  <div class="alert alert-success alert-dismissible fade show" role="alert"
       th:if="${msg != null and !#strings.isEmpty(msg)}">
    <span th:text="${msg}">Ação realizada com sucesso!</span>
    <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
  </div>

  <div class="alert alert-danger alert-dismissible fade show" role="alert"
       th:if="${erro != null and !#strings.isEmpty(erro)}">
    <span th:text="${erro}">Ocorreu um erro</span>
    <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
  </div>
</div>

<main class="main-page">
  <div class="container-fluid">

    <div class="page-header">
      <h1 class="page-title">Gestão de Almoxarifado</h1>
      <div class="page-actions">
        <button class="btn btn-outline-secondary" data-bs-toggle="modal" data-bs-target="#modalGerarRelatorio">
          <i class="bi bi-file-earmark-arrow-down me-2"></i>Gerar Relatório
        </button>
        <button class="btn btn-outline-primary" data-bs-toggle="modal" data-bs-target="#modalNovaCategoria">
          <i class="bi bi-tags-fill me-2"></i>Nova Categoria
        </button>
        <button class="btn btn-secondary" data-bs-toggle="modal" data-bs-target="#modalSolicitarMaterial">
          <i class="bi bi-hand-index-thumb me-2"></i>Solicitar Material
        </button>
        <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#modalAdicionarMaterial">
          <i class="bi bi-plus-circle me-2"></i>Adicionar Novo Material
        </button>
      </div>
    </div>

    <!-- === TABS PRINCIPAIS === -->
    <ul class="nav nav-tabs mt-3" id="almoxarifadoTabs" role="tablist">
      <li class="nav-item" role="presentation">
        <button class="nav-link active p-2" id="estoque-tab" data-bs-toggle="tab" data-bs-target="#estoque-tab-pane"
                type="button" role="tab" aria-controls="estoque-tab-pane" aria-selected="true">
          <i class="bi bi-box-seam"></i> Estoque Atual
        </button>
      </li>
      <li class="nav-item" role="presentation">
        <button class="nav-link p-2" id="solicitacoes-tab" data-bs-toggle="tab" data-bs-target="#solicitacoes-tab-pane"
                type="button" role="tab" aria-controls="solicitacoes-tab-pane" aria-selected="false">
          <i class="bi bi-card-checklist me-2"></i>Acompanhamento de Solicitações
        </button>
      </li>
      <li class="nav-item" role="presentation">
        <button class="nav-link p-2" id="categorias-tab" data-bs-toggle="tab" data-bs-target="#categorias-tab-pane"
                type="button" role="tab" aria-controls="categorias-tab-pane" aria-selected="false">
          <i class="bi bi-tags me-2"></i>Categorias
        </button>
      </li>
    </ul>

    <div class="tab-content card" id="almoxarifadoTabsContent">

      <!-- === TAB ESTOQUE === -->
      <div class="tab-pane fade show active" id="estoque-tab-pane" role="tabpanel" aria-labelledby="estoque-tab">
        <div class="card-body">
          <div class="table-responsive">
            <table class="table table-hover align-middle">
              <thead class="table-light">
              <tr>
                <th>ID</th>
                <th>Nome do Material</th>
                <th>Categoria</th>
                <th>Quantidade</th>
                <th>Validade</th>
                <th>Fornecedor</th>
                <th class="text-end">Ações</th>
              </tr>
              </thead>
              <tbody>
              <tr th:each="material : ${materiais}">
                <td th:text="${material.idMaterial}">1</td>
                <td th:text="${material.nome}">Nome</td>
                <td th:text="${material.categoria != null && material.categoria.nome != null ? material.categoria.nome : 'N/A'}">Categoria</td>
                <td th:text="${material.quantidadeAtual != null ? material.quantidadeAtual + ' Un.' : '0 Un.'}">0 Un.</td>
                <td th:text="${material.dataValidade != null ? #temporals.format(material.dataValidade, 'dd/MM/yyyy') : 'Sem validade'}">Validade</td>
                <td th:text="${material.fornecedor != null ? material.fornecedor : 'N/A'}">Fornecedor</td>
                <td class="text-end">
                  <button class="btn btn-sm btn-outline-secondary me-2" title="Editar"
                          data-action="editar-material" th:attr="data-id=${material.idMaterial}">
                    <i class="bi bi-pencil"></i>
                  </button>
                  <button class="btn btn-sm btn-outline-danger" title="Excluir"
                          data-action="excluir-material" th:attr="data-id=${material.idMaterial}">
                    <i class="bi bi-trash"></i>
                  </button>
                </td>
              </tr>
              <tr th:if="${#lists.isEmpty(materiais)}">
                <td colspan="7" class="text-center text-muted">Nenhum material cadastrado</td>
              </tr>
              </tbody>
            </table>
          </div>
        </div>
      </div>

      <!-- === TAB SOLICITAÇÕES === -->
      <div class="tab-pane fade" id="solicitacoes-tab-pane" role="tabpanel" aria-labelledby="solicitacoes-tab">
        <div class="card-body">
          <div class="table-responsive">
            <table class="table table-hover align-middle">
              <thead class="table-light">
              <tr>
                <th>ID</th>
                <th>Material</th>
                <th>Qtd.</th>
                <th>Solicitante</th>
                <th>Data</th>
                <th>Status</th>
                <th class="text-end">Ações</th>
              </tr>
              </thead>
              <tbody>
              <tr th:each="sol : ${solicitacoes}">
                <td th:text="${sol.idSolicitacao}">101</td>
                <td th:text="${sol.material != null && sol.material.nome != null ? sol.material.nome : 'N/A'}">Material</td>
                <td th:text="${sol.quantidadeSolicitada}">0</td>
                <td th:text="${sol.funcionarioSolicitante != null && sol.funcionarioSolicitante.nome != null ? sol.funcionarioSolicitante.nome : 'N/A'}">Solicitante</td>
                <td th:text="${sol.dataSolicitacao != null ? #temporals.format(sol.dataSolicitacao, 'dd/MM/yyyy HH:mm') : 'N/A'}">Data</td>
                <td>
                    <span th:class="${sol.status != null ? (sol.status.name() == 'PENDENTE' ? 'badge bg-warning' : (sol.status.name() == 'APROVADA' ? 'badge bg-success' : 'badge bg-danger')) : 'badge bg-secondary'}"
                          th:text="${sol.status != null ? sol.status : 'N/A'}">Status</span>
                </td>
                <td class="text-end">
                  <button th:if="${sol.status != null && sol.status.name() == 'PENDENTE'}"
                          class="btn btn-sm btn-success me-2" title="Aprovar"
                          data-action="aprovar-solicitacao" th:attr="data-id=${sol.idSolicitacao}">
                    <i class="bi bi-check-lg text-white"></i>
                  </button>
                  <button th:if="${sol.status != null && sol.status.name() == 'PENDENTE'}"
                          class="btn btn-sm btn-danger" title="Recusar"
                          data-action="recusar-solicitacao" th:attr="data-id=${sol.idSolicitacao}">
                    <i class="bi bi-x-lg text-white"></i>
                  </button>
                </td>
              </tr>
              <tr th:if="${#lists.isEmpty(solicitacoes)}">
                <td colspan="7" class="text-center text-muted">Nenhuma solicitação registrada</td>
              </tr>
              </tbody>
            </table>
          </div>
        </div>
      </div>

      <!-- === NOVA ABA: CATEGORIAS === -->
      <div class="tab-pane fade" id="categorias-tab-pane" role="tabpanel" aria-labelledby="categorias-tab">
        <div class="card-body">
          <div class="table-responsive">
            <table class="table table-hover align-middle">
              <thead class="table-light">
              <tr>
                <th>ID</th>
                <th>Nome da Categoria</th>
                <th class="text-end">Ações</th>
              </tr>
              </thead>
              <tbody>
              <tr th:each="cat : ${categorias}">
                <td th:text="${cat.idCategoria}">1</td>
                <td th:text="${cat.nome}">Categoria</td>
                <td class="text-end">
                  <button class="btn btn-sm btn-outline-secondary me-2"
                          title="Editar"
                          data-action="editar-categoria"
                          th:attr="data-id=${cat.idCategoria}, data-nome=${cat.nome}">
                    <i class="bi bi-pencil"></i>
                  </button>
                  <button class="btn btn-sm btn-outline-danger"
                          title="Excluir"
                          data-action="excluir-categoria"
                          th:attr="data-id=${cat.idCategoria}">
                    <i class="bi bi-trash"></i>
                  </button>
                </td>
              </tr>
              <tr th:if="${#lists.isEmpty(categorias)}">
                <td colspan="3" class="text-center text-muted">Nenhuma categoria cadastrada</td>
              </tr>
              </tbody>
            </table>
          </div>
        </div>
      </div>

    </div>
  </div>
</main>

<!-- === MODAIS === -->

<!-- Modal: Adicionar Material -->
<div class="modal fade" id="modalAdicionarMaterial" tabindex="-1" aria-labelledby="modalAdicionarMaterialLabel" aria-hidden="true">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header">
        <h1 class="modal-title fs-5" id="modalAdicionarMaterialLabel">Adicionar Novo Material</h1>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <form th:action="@{/almoxarifado/material/salvar}" method="post">
        <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}" th:if="${_csrf != null}"/>
        <div class="modal-body">
          <div class="row g-3">
            <div class="col-md-6">
              <label for="materialNome" class="form-label">Nome do Material</label>
              <input type="text" class="form-control" id="materialNome" name="nome" required />
            </div>
            <div class="col-md-6">
              <label for="materialCategoria" class="form-label">Categoria</label>
              <select class="form-select" id="materialCategoria" name="categoria.idCategoria" required>
                <option value="">Selecione...</option>
                <option th:each="cat : ${categorias}" th:value="${cat.idCategoria}" th:text="${cat.nome}">Categoria</option>
              </select>
            </div>
            <div class="col-md-4">
              <label for="materialQtd" class="form-label">Quantidade</label>
              <input type="number" class="form-control" id="materialQtd" name="quantidadeAtual" min="0" required />
            </div>
            <div class="col-md-4">
              <label for="materialValidade" class="form-label">Validade</label>
              <input type="date" class="form-control" id="materialValidade" name="dataValidade" />
            </div>
            <div class="col-md-4">
              <label for="materialFornecedor" class="form-label">Fornecedor</label>
              <input type="text" class="form-control" id="materialFornecedor" name="fornecedor" />
            </div>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
          <button type="submit" class="btn btn-primary">Salvar Material</button>
        </div>
      </form>
    </div>
  </div>
</div>

<!-- Modal: Editar Material -->
<div class="modal fade" id="modalEditarMaterial" tabindex="-1" aria-labelledby="modalEditarMaterialLabel" aria-hidden="true">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header">
        <h1 class="modal-title fs-5" id="modalEditarMaterialLabel">Editar Material</h1>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <form th:action="@{/almoxarifado/material/salvar}" method="post">
        <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}" th:if="${_csrf != null}"/>
        <input type="hidden" id="editMaterialId" name="idMaterial" />
        <div class="modal-body">
          <div class="row g-3">
            <div class="col-md-6">
              <label for="editMaterialNome" class="form-label">Nome do Material</label>
              <input type="text" class="form-control" id="editMaterialNome" name="nome" required />
            </div>
            <div class="col-md-6">
              <label for="editMaterialCategoria" class="form-label">Categoria</label>
              <select class="form-select" id="editMaterialCategoria" name="categoria.idCategoria" required>
                <option value="">Selecione...</option>
                <option th:each="cat : ${categorias}" th:value="${cat.idCategoria}" th:text="${cat.nome}">Categoria</option>
              </select>
            </div>
            <div class="col-md-4">
              <label for="editMaterialQtd" class="form-label">Quantidade</label>
              <input type="number" class="form-control" id="editMaterialQtd" name="quantidadeAtual" min="0" required />
            </div>
            <div class="col-md-4">
              <label for="editMaterialValidade" class="form-label">Validade</label>
              <input type="date" class="form-control" id="editMaterialValidade" name="dataValidade" />
            </div>
            <div class="col-md-4">
              <label for="editMaterialFornecedor" class="form-label">Fornecedor</label>
              <input type="text" class="form-control" id="editMaterialFornecedor" name="fornecedor" />
            </div>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
          <button type="submit" class="btn btn-primary">Salvar Alterações</button>
        </div>
      </form>
    </div>
  </div>
</div>

<!-- Modal: Solicitar Material -->
<div class="modal fade" id="modalSolicitarMaterial" tabindex="-1" aria-labelledby="modalSolicitarMaterialLabel" aria-hidden="true">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header">
        <h1 class="modal-title fs-5" id="modalSolicitarMaterialLabel">Solicitar Material</h1>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <form th:action="@{/almoxarifado/solicitacao/salvar}" method="post">
        <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}" th:if="${_csrf != null}"/>
        <div class="modal-body">
          <div class="row g-3">
            <div class="col-md-8">
              <label for="solicitacaoMaterial" class="form-label">Material</label>
              <select class="form-select" id="solicitacaoMaterial" name="material.idMaterial" required>
                <option value="">Selecione...</option>
                <option th:each="mat : ${materiais}" th:value="${mat.idMaterial}" th:text="${mat.nome}">Material</option>
              </select>
            </div>
            <div class="col-md-4">
              <label for="solicitacaoQtd" class="form-label">Quantidade</label>
              <input type="number" class="form-control" id="solicitacaoQtd" name="quantidadeSolicitada" min="1" required />
            </div>
            <div class="col-12">
              <label for="solicitacaoJustificativa" class="form-label">Justificativa</label>
              <textarea class="form-control" id="solicitacaoJustificativa" name="justificativa" rows="3"></textarea>
            </div>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
          <button type="submit" class="btn btn-primary">Enviar Solicitação</button>
        </div>
      </form>
    </div>
  </div>
</div>

<!-- Modal: Nova Categoria -->
<div class="modal fade" id="modalNovaCategoria" tabindex="-1" aria-labelledby="modalNovaCategoriaLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h1 class="modal-title fs-5" id="modalNovaCategoriaLabel">Nova Categoria</h1>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <form th:action="@{/almoxarifado/categoria/salvar}" method="post">
        <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}" th:if="${_csrf != null}"/>
        <input type="hidden" name="idCategoria" value="" />
        <div class="modal-body">
          <div class="mb-3">
            <label for="categoriaNome" class="form-label">Nome da Categoria</label>
            <input type="text" class="form-control" id="categoriaNome" name="nome" required />
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
          <button type="submit" class="btn btn-primary">Salvar Categoria</button>
        </div>
      </form>
    </div>
  </div>
</div>

<!-- Modal: Gerar Relatório -->
<div class="modal fade" id="modalGerarRelatorio" tabindex="-1" aria-labelledby="modalGerarRelatorioLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h1 class="modal-title fs-5" id="modalGerarRelatorioLabel">Gerar Relatório</h1>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <form th:action="@{/almoxarifado/relatorio/gerar}" method="post">
        <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}" th:if="${_csrf != null}"/>
        <div class="modal-body">
          <div class="mb-3">
            <label for="relatorioTipo" class="form-label">Tipo de Relatório</label>
            <select class="form-select" id="relatorioTipo" name="tipo" required>
              <option value="">Selecione...</option>
              <option value="estoque">Estoque Atual</option>
              <option value="solicitacoes">Solicitações</option>
              <option value="movimentacao">Movimentação</option>
            </select>
          </div>
          <div class="row g-3">
            <div class="col-6">
              <label for="relatorioDataInicio" class="form-label">Data Início</label>
              <input type="date" class="form-control" id="relatorioDataInicio" name="dataInicio" />
            </div>
            <div class="col-6">
              <label for="relatorioDataFim" class="form-label">Data Fim</label>
              <input type="date" class="form-control" id="relatorioDataFim" name="dataFim" />
            </div>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
          <button type="submit" class="btn btn-primary">Gerar</button>
        </div>
      </form>
    </div>
  </div>
</div>

<footer th:replace="~{fragments/base :: rodape}"></footer>

<!-- Bootstrap Bundle -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js" defer></script>

<!-- JavaScript da Página -->
<script th:inline="javascript" defer>
  /*<![CDATA[*/
  // Delegação centralizada para todos botões com data-action
  document.addEventListener('click', function (e) {
    const btn = e.target.closest('button[data-action]');
    if (!btn) return;

    const action = btn.dataset.action;
    const id = btn.dataset.id;

    switch (action) {
      case 'editar-material':
        return editarMaterial(id);
      case 'excluir-material':
        return confirmarExclusao(id);
      case 'aprovar-solicitacao':
        return aprovarSolicitacao(id);
      case 'recusar-solicitacao':
        return recusarSolicitacao(id);
      case 'editar-categoria':
        return abrirModalCategoria(id, btn.dataset.nome || '');
      case 'excluir-categoria':
        return confirmarExclusaoCategoria(id);
    }
  });

  function abrirModalCategoria(id, nome) {
    const nomeEl = document.getElementById('categoriaNome');
    const idEl = document.querySelector('#modalNovaCategoria input[name="idCategoria"]');
    if (nomeEl) nomeEl.value = nome || '';
    if (idEl) idEl.value = id || '';

    const modalEl = document.getElementById('modalNovaCategoria');
    if (!modalEl) return console.error('Elemento #modalNovaCategoria não encontrado');
    const modal = bootstrap.Modal.getOrCreateInstance(modalEl);
    modal.show();
  }

  function editarMaterial(id) {
    fetch(`/almoxarifado/material/${id}`)
      .then(r => r.json())
      .then(material => {
        document.getElementById('editMaterialId').value = material.idMaterial;
        document.getElementById('editMaterialNome').value = material.nome;
        document.getElementById('editMaterialCategoria').value =
          (material.categoria && material.categoria.idCategoria) ? material.categoria.idCategoria : '';
        document.getElementById('editMaterialQtd').value = material.quantidadeAtual;
        document.getElementById('editMaterialValidade').value = material.dataValidade || '';
        document.getElementById('editMaterialFornecedor').value = material.fornecedor || '';

        const modalEl = document.getElementById('modalEditarMaterial');
        if (!modalEl) return console.error('Elemento #modalEditarMaterial não encontrado');
        const modal = bootstrap.Modal.getOrCreateInstance(modalEl);
        modal.show();
      })
      .catch(err => alert('Erro ao carregar material: ' + err));
  }

  function confirmarExclusao(id) {
    if (confirm('Tem certeza que deseja excluir este material?')) {
      window.location.href = `/almoxarifado/material/deletar/${id}`;
    }
  }

  function confirmarExclusaoCategoria(id) {
    if (confirm('Excluir esta categoria?')) {
      window.location.href = `/almoxarifado/categoria/deletar/${id}`;
    }
  }

  function aprovarSolicitacao(id) {
    if (confirm('Aprovar esta solicitação?')) {
      window.location.href = `/almoxarifado/solicitacao/aprovar/${id}`;
    }
  }

  function recusarSolicitacao(id) {
    if (confirm('Recusar esta solicitação?')) {
      window.location.href = `/almoxarifado/solicitacao/recusar/${id}`;
    }
  }
  /*]]>*/
</script>

</body>
</html>