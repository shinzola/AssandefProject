<!DOCTYPE html>
<html lang="pt-br" xmlns:th="http://www.thymeleaf.org">
<head th:replace="~{fragments/base :: headPadrao('Gestão de Doadores')}">
</head>

<body>

<header th:replace="~{fragments/base :: cabecalho}"></header>

<!-- FLASH MESSAGES -->
<div class="container mt-3" th:if="${(msg != null and !#strings.isEmpty(msg)) or (erro != null and !#strings.isEmpty(erro))}">
    <div class="alert alert-success alert-dismissible fade show" role="alert"
         th:if="${msg != null and !#strings.isEmpty(msg)}">
        <span th:text="${msg}">Ação realizada com sucesso!</span>
        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
    </div>

    <div class="alert alert-danger alert-dismissible fade show" role="alert"
         th:if="${erro != null and !#strings.isEmpty(erro)}">
        <span th:text="${erro}">Ocorreu um erro</span>
        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
    </div>
</div>

<main class="main-page">
    <div class="container-fluid">
        <div class="page-header">
            <h1 class="page-title">Gestão de Doadores</h1>
            <div class="page-actions">
                <button
                        class="btn btn-primary"
                        data-bs-toggle="modal"
                        data-bs-target="#modalNovoDoador"
                >
                    <i class="bi bi-person-plus-fill me-2"></i>Cadastrar Novo Doador
                </button>
                <button
                        class="btn btn-secondary"
                        data-bs-toggle="modal"
                        data-bs-target="#modalNovoBoleto"
                >
                    <i class="bi bi-file-earmark-text me-2"></i>Cadastrar Boleto
                </button>
            </div>
        </div>

        <ul class="nav nav-tabs mt-4" id="doadoresTabs" role="tablist">
            <li class="nav-item" role="presentation">
                <button
                        class="nav-link active"
                        id="lista-doadores-tab"
                        data-bs-toggle="tab"
                        data-bs-target="#lista-doadores-pane"
                        type="button"
                        role="tab"
                        aria-controls="lista-doadores-pane"
                        aria-selected="true"
                >
                    <i class="bi bi-people-fill me-2"></i>Lista de Doadores
                </button>
            </li>
            <li class="nav-item" role="presentation">
                <button
                        class="nav-link"
                        id="boletos-tab"
                        data-bs-toggle="tab"
                        data-bs-target="#boletos-pane"
                        type="button"
                        role="tab"
                        aria-controls="boletos-pane"
                        aria-selected="false"
                >
                    <i class="bi bi-file-earmark-text me-2"></i>Boletos
                </button>
            </li>
        </ul>

        <div class="tab-content card" id="doadoresTabsContent">
            <!-- TAB: LISTA DE DOADORES -->
            <div
                    class="tab-pane fade show active"
                    id="lista-doadores-pane"
                    role="tabpanel"
                    aria-labelledby="lista-doadores-tab"
                    tabindex="0"
            >
                <div class="card-body">
                    <div class="row g-3 mb-4">
                        <div class="col-md-8">
                            <div class="input-group">
                                <input
                                        type="text"
                                        class="form-control"
                                        placeholder="Buscar por nome ou CPF/CNPJ do doador..."
                                        id="buscaDoador"
                                />
                                <button class="btn btn-outline-primary" type="button">
                                    <i class="bi bi-search"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                    <div class="table-responsive">
                        <table class="table table-hover align-middle" id="tabelaDoadores">
                            <thead class="table-light">
                            <tr>
                                <th scope="col">ID</th>
                                <th scope="col">Nome</th>
                                <th scope="col">CPF/CNPJ</th>
                                <th scope="col">Telefone</th>
                                <th scope="col">Email</th>
                                <th scope="col">Mensalidade</th>
                                <th scope="col" class="text-end">Ações</th>
                            </tr>
                            </thead>
                            <tbody>
                            <tr th:each="doador : ${doadores}">
                                <th scope="row" th:text="${doador.idDoador}">1</th>
                                <td th:text="${doador.nome}">Nome</td>
                                <td th:text="${doador.cpfCnpj}">000.000.000-00</td>
                                <td th:text="${doador.telefone}">Telefone</td>
                                <td th:text="${doador.email}">Email</td>
                                <td th:text="${doador.mensalidade != null ? 'R$ ' + #numbers.formatDecimal(doador.mensalidade, 1, 'POINT', 2, 'COMMA') : 'N/A'}">R$ 0,00</td>
                                <td class="text-end">
                                    <button
                                            class="btn btn-sm btn-outline-secondary me-2"
                                            title="Editar"
                                            data-action="editar-doador"
                                            th:attr="data-id=${doador.idDoador}"
                                    >
                                        <i class="bi bi-pencil"></i>
                                    </button>
                                    <button
                                            class="btn btn-sm btn-outline-danger"
                                            title="Excluir"
                                            data-action="excluir-doador"
                                            th:attr="data-id=${doador.idDoador}"
                                    >
                                        <i class="bi bi-trash"></i>
                                    </button>
                                </td>
                            </tr>
                            <tr th:if="${#lists.isEmpty(doadores)}">
                                <td colspan="7" class="text-center text-muted">Nenhum doador cadastrado</td>
                            </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- TAB: BOLETOS -->
            <div
                    class="tab-pane fade"
                    id="boletos-pane"
                    role="tabpanel"
                    aria-labelledby="boletos-tab"
                    tabindex="0"
            >
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-hover align-middle">
                            <thead class="table-light">
                            <tr>
                                <th scope="col">ID</th>
                                <th scope="col">Doador</th>
                                <th scope="col">Status</th>
                                <th scope="col">Link do Boleto</th>
                                <th scope="col" class="text-end">Ações</th>
                            </tr>
                            </thead>
                            <tbody>
                            <tr th:each="boleto : ${boletos}">
                                <th scope="row" th:text="${boleto.idBoleto}">1</th>
                                <td th:text="${boleto.doador != null ? boleto.doador.nome : 'N/A'}">Doador</td>
                                <td>
                                    <span th:class="${boleto.status != null ? (boleto.status.name() == 'PAGO' ? 'badge bg-success' : (boleto.status.name() == 'PENDENTE' ? 'badge bg-warning' : 'badge bg-danger')) : 'badge bg-secondary'}"
                                          th:text="${boleto.status != null ? boleto.status : 'N/A'}">Status</span>
                                </td>
                                <td>
                                    <a th:if="${boleto.pdfBoleto != null and !#strings.isEmpty(boleto.pdfBoleto)}"
                                       th:href="${boleto.pdfBoleto}"
                                       target="_blank"
                                       class="btn btn-sm btn-outline-primary">
                                        <i class="bi bi-link-45deg me-1"></i>Ver Boleto
                                    </a>
                                    <span th:if="${boleto.pdfBoleto == null or #strings.isEmpty(boleto.pdfBoleto)}"
                                          class="text-muted">Sem link</span>
                                </td>
                                <td class="text-end">
                                    <button
                                            th:if="${boleto.status != null and boleto.status.name() == 'PENDENTE'}"
                                            class="btn btn-sm btn-success me-2"
                                            title="Marcar como Pago"
                                            data-action="marcar-pago"
                                            th:attr="data-id=${boleto.idBoleto}"
                                    >
                                        <i class="bi bi-check-lg text-white"></i>
                                    </button>
                                    <button
                                            th:if="${boleto.status != null and boleto.status.name() == 'PENDENTE'}"
                                            class="btn btn-sm btn-danger me-2"
                                            title="Marcar como Vencido"
                                            data-action="marcar-vencido"
                                            th:attr="data-id=${boleto.idBoleto}"
                                    >
                                        <i class="bi bi-x-lg text-white"></i>
                                    </button>
                                    <button
                                            class="btn btn-sm btn-outline-secondary me-2"
                                            title="Editar"
                                            data-action="editar-boleto"
                                            th:attr="data-id=${boleto.idBoleto}"
                                    >
                                        <i class="bi bi-pencil"></i>
                                    </button>
                                    <button
                                            class="btn btn-sm btn-outline-danger"
                                            title="Excluir"
                                            data-action="excluir-boleto"
                                            th:attr="data-id=${boleto.idBoleto}"
                                    >
                                        <i class="bi bi-trash"></i>
                                    </button>
                                </td>
                            </tr>
                            <tr th:if="${#lists.isEmpty(boletos)}">
                                <td colspan="5" class="text-center text-muted">Nenhum boleto cadastrado</td>
                            </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
</main>

<footer th:replace="~{fragments/base :: rodape}"></footer>

<!-- MODAL: NOVO DOADOR -->
<div
        class="modal fade"
        id="modalNovoDoador"
        tabindex="-1"
        aria-labelledby="modalNovoDoadorLabel"
        aria-hidden="true"
>
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h1 class="modal-title fs-5" id="modalNovoDoadorLabel">
                    Cadastrar Novo Doador
                </h1>
                <button
                        type="button"
                        class="btn-close"
                        data-bs-dismiss="modal"
                        aria-label="Close"
                ></button>
            </div>
            <form th:action="@{/doadores/salvar}" method="post">
                <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}" th:if="${_csrf != null}"/>
                <div class="modal-body">
                    <div class="row g-3">
                        <div class="col-12">
                            <label for="doadorNome" class="form-label">Nome / Razão Social</label>
                            <input type="text" class="form-control" id="doadorNome" name="nome" required/>
                        </div>
                        <div class="col-md-6">
                            <label for="doadorCpfCnpj" class="form-label">CPF / CNPJ</label>
                            <input type="text" class="form-control" id="doadorCpfCnpj" name="cpfCnpj" required/>
                        </div>
                        <div class="col-md-6">
                            <label for="doadorTelefone" class="form-label">Telefone</label>
                            <input type="text" class="form-control" id="doadorTelefone" name="telefone"/>
                        </div>
                        <div class="col-md-6">
                            <label for="doadorEmail" class="form-label">Email</label>
                            <input type="email" class="form-control" id="doadorEmail" name="email"/>
                        </div>
                        <div class="col-md-6">
                            <label for="doadorNascimento" class="form-label">Data de Nascimento</label>
                            <input type="date" class="form-control" id="doadorNascimento" name="dataNascimento"/>
                        </div>
                        <div class="col-md-6">
                            <label for="doadorSexo" class="form-label">Sexo</label>
                            <select id="doadorSexo" class="form-select" name="sexo">
                                <option value="">Selecione...</option>
                                <option>Masculino</option>
                                <option>Feminino</option>
                                <option>Outro</option>
                                <option>Pessoa Jurídica</option>
                            </select>
                        </div>
                        <div class="col-md-6">
                            <label for="doadorMensalidade" class="form-label">Valor Mensalidade (R$)</label>
                            <input type="number" class="form-control" id="doadorMensalidade" name="mensalidade" step="0.01" placeholder="0.00"/>
                        </div>
                        <div class="col-md-6">
                            <label for="doadorVencimento" class="form-label">Data Vencimento</label>
                            <input type="date" class="form-control" id="doadorVencimento" name="dataVencimento"/>
                        </div>
                        <div class="col-12">
                            <label for="doadorEndereco" class="form-label">Endereço</label>
                            <input type="text" class="form-control" id="doadorEndereco" name="endereco" placeholder="Rua, Nº, Bairro"/>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button
                            type="button"
                            class="btn btn-secondary"
                            data-bs-dismiss="modal"
                    >
                        Cancelar
                    </button>
                    <button type="submit" class="btn btn-primary">
                        Salvar Cadastro
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- MODAL: EDITAR DOADOR -->
<div
        class="modal fade"
        id="modalEditarDoador"
        tabindex="-1"
        aria-labelledby="modalEditarDoadorLabel"
        aria-hidden="true"
>
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h1 class="modal-title fs-5" id="modalEditarDoadorLabel">
                    Editar Doador
                </h1>
                <button
                        type="button"
                        class="btn-close"
                        data-bs-dismiss="modal"
                        aria-label="Close"
                ></button>
            </div>
            <form th:action="@{/doadores/salvar}" method="post">
                <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}" th:if="${_csrf != null}"/>
                <input type="hidden" id="editDoadorId" name="idDoador"/>
                <div class="modal-body">
                    <div class="row g-3">
                        <div class="col-12">
                            <label for="editDoadorNome" class="form-label">Nome / Razão Social</label>
                            <input type="text" class="form-control" id="editDoadorNome" name="nome" required/>
                        </div>
                        <div class="col-md-6">
                            <label for="editDoadorCpfCnpj" class="form-label">CPF / CNPJ</label>
                            <input type="text" class="form-control" id="editDoadorCpfCnpj" name="cpfCnpj" required/>
                        </div>
                        <div class="col-md-6">
                            <label for="editDoadorTelefone" class="form-label">Telefone</label>
                            <input type="text" class="form-control" id="editDoadorTelefone" name="telefone"/>
                        </div>
                        <div class="col-md-6">
                            <label for="editDoadorEmail" class="form-label">Email</label>
                            <input type="email" class="form-control" id="editDoadorEmail" name="email"/>
                        </div>
                        <div class="col-md-6">
                            <label for="editDoadorNascimento" class="form-label">Data de Nascimento</label>
                            <input type="date" class="form-control" id="editDoadorNascimento" name="dataNascimento"/>
                        </div>
                        <div class="col-md-6">
                            <label for="editDoadorSexo" class="form-label">Sexo</label>
                            <select id="editDoadorSexo" class="form-select" name="sexo">
                                <option value="">Selecione...</option>
                                <option>Masculino</option>
                                <option>Feminino</option>
                                <option>Outro</option>
                                <option>Pessoa Jurídica</option>
                            </select>
                        </div>
                        <div class="col-md-6">
                            <label for="editDoadorMensalidade" class="form-label">Valor Mensalidade (R$)</label>
                            <input type="number" class="form-control" id="editDoadorMensalidade" name="mensalidade" step="0.01" placeholder="0.00"/>
                        </div>
                        <div class="col-md-6">
                            <label for="editDoadorVencimento" class="form-label">Data Vencimento</label>
                            <input type="date" class="form-control" id="editDoadorVencimento" name="dataVencimento"/>
                        </div>
                        <div class="col-12">
                            <label for="editDoadorEndereco" class="form-label">Endereço</label>
                            <input type="text" class="form-control" id="editDoadorEndereco" name="endereco" placeholder="Rua, Nº, Bairro"/>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button
                            type="button"
                            class="btn btn-secondary"
                            data-bs-dismiss="modal"
                    >
                        Cancelar
                    </button>
                    <button type="submit" class="btn btn-primary">
                        Salvar Alterações
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- MODAL: NOVO BOLETO -->
<div
        class="modal fade"
        id="modalNovoBoleto"
        tabindex="-1"
        aria-labelledby="modalNovoBoletoLabel"
        aria-hidden="true"
>
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h1 class="modal-title fs-5" id="modalNovoBoletoLabel">
                    Cadastrar Novo Boleto
                </h1>
                <button
                        type="button"
                        class="btn-close"
                        data-bs-dismiss="modal"
                        aria-label="Close"
                ></button>
            </div>
            <form th:action="@{/doadores/boleto/salvar}" method="post">
                <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}" th:if="${_csrf != null}"/>
                <div class="modal-body">
                    <div class="mb-3">
                        <label for="boletoDoador" class="form-label">Doador</label>
                        <select class="form-select" id="boletoDoador" name="doador.idDoador" required>
                            <option value="">Selecione...</option>
                            <option th:each="doador : ${doadores}" th:value="${doador.idDoador}" th:text="${doador.nome}">Doador</option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <label for="boletoStatus" class="form-label">Status</label>
                        <select class="form-select" id="boletoStatus" name="status" required>
                            <option value="PENDENTE" selected>Pendente</option>
                            <option value="PAGO">Pago</option>
                            <option value="VENCIDO">Vencido</option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <label for="boletoPdf" class="form-label">Arquivo do Boleto (PDF)</label>
                        <input type="file" class="form-control" id="boletoPdf" name="arquivo" accept=".pdf" required/>
                        <div class="form-text">Selecione o arquivo PDF do boleto (máximo 10MB)</div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button
                            type="button"
                            class="btn btn-secondary"
                            data-bs-dismiss="modal"
                    >
                        Cancelar
                    </button>
                    <button type="submit" class="btn btn-primary">
                        Salvar Boleto
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- MODAL: EDITAR BOLETO -->
<div
        class="modal fade"
        id="modalEditarBoleto"
        tabindex="-1"
        aria-labelledby="modalEditarBoletoLabel"
        aria-hidden="true"
>
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h1 class="modal-title fs-5" id="modalEditarBoletoLabel">
                    Editar Boleto
                </h1>
                <button
                        type="button"
                        class="btn-close"
                        data-bs-dismiss="modal"
                        aria-label="Close"
                ></button>
            </div>
            <form th:action="@{/doadores/boleto/salvar}" method="post">
                <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}" th:if="${_csrf != null}"/>
                <input type="hidden" id="editBoletoId" name="idBoleto"/>
                <div class="modal-body">
                    <div class="mb-3">
                        <label for="editBoletoDoador" class="form-label">Doador</label>
                        <select class="form-select" id="editBoletoDoador" name="doador.idDoador" required>
                            <option value="">Selecione...</option>
                            <option th:each="doador : ${doadores}" th:value="${doador.idDoador}" th:text="${doador.nome}">Doador</option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <label for="editBoletoStatus" class="form-label">Status</label>
                        <select class="form-select" id="editBoletoStatus" name="status" required>
                            <option value="PENDENTE">Pendente</option>
                            <option value="PAGO">Pago</option>
                            <option value="VENCIDO">Vencido</option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <label for="editBoletoPdf" class="form-label">Link do Boleto (PDF)</label>
                        <input type="url" class="form-control" id="editBoletoPdf" name="pdfBoleto" placeholder="https://exemplo.com/boleto.pdf"/>
                        <div class="form-text">Cole o link/URL do boleto aqui</div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button
                            type="button"
                            class="btn btn-secondary"
                            data-bs-dismiss="modal"
                    >
                        Cancelar
                    </button>
                    <button type="submit" class="btn btn-primary">
                        Salvar Alterações
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<script
        src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"
        integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz"
        crossorigin="anonymous"
></script>

<!-- JavaScript da Página -->
<script th:inline="javascript" defer>
    /*<![CDATA[*/
    // Delegação centralizada para todos botões com data-action
    document.addEventListener('click', function (e) {
        const btn = e.target.closest('button[data-action]');
        if (!btn) return;

        const action = btn.dataset.action;
        const id = btn.dataset.id;

        switch (action) {
            case 'editar-doador':
                return editarDoador(id);
            case 'excluir-doador':
                return confirmarExclusaoDoador(id);
            case 'editar-boleto':
                return editarBoleto(id);
            case 'excluir-boleto':
                return confirmarExclusaoBoleto(id);
            case 'marcar-pago':
                return marcarComoPago(id);
            case 'marcar-vencido':
                return marcarComoVencido(id);
        }
    });

    // ========== DOADOR ==========
    function editarDoador(id) {
        fetch(`/doadores/${id}`)
            .then(r => r.json())
            .then(doador => {
                document.getElementById('editDoadorId').value = doador.idDoador;
                document.getElementById('editDoadorNome').value = doador.nome || '';
                document.getElementById('editDoadorCpfCnpj').value = doador.cpfCnpj || '';
                document.getElementById('editDoadorTelefone').value = doador.telefone || '';
                document.getElementById('editDoadorEmail').value = doador.email || '';
                document.getElementById('editDoadorNascimento').value = doador.dataNascimento || '';
                document.getElementById('editDoadorSexo').value = doador.sexo || '';
                document.getElementById('editDoadorMensalidade').value = doador.mensalidade || '';
                document.getElementById('editDoadorVencimento').value = doador.dataVencimento || '';
                document.getElementById('editDoadorEndereco').value = doador.endereco || '';

                const modalEl = document.getElementById('modalEditarDoador');
                if (!modalEl) return console.error('Elemento #modalEditarDoador não encontrado');
                const modal = bootstrap.Modal.getOrCreateInstance(modalEl);
                modal.show();
            })
            .catch(err => alert('Erro ao carregar doador: ' + err));
    }

    function confirmarExclusaoDoador(id) {
        if (confirm('Tem certeza que deseja excluir este doador?')) {
            window.location.href = `/doadores/deletar/${id}`;
        }
    }

    // ========== BOLETO ==========
    function editarBoleto(id) {
        fetch(`/doadores/boleto/${id}`)
            .then(r => r.json())
            .then(boleto => {
                document.getElementById('editBoletoId').value = boleto.idBoleto;
                document.getElementById('editBoletoDoador').value =
                    (boleto.doador && boleto.doador.idDoador) ? boleto.doador.idDoador : '';
                document.getElementById('editBoletoStatus').value = boleto.status || 'PENDENTE';
                document.getElementById('editBoletoPdf').value = boleto.pdfBoleto || '';

                const modalEl = document.getElementById('modalEditarBoleto');
                if (!modalEl) return console.error('Elemento #modalEditarBoleto não encontrado');
                const modal = bootstrap.Modal.getOrCreateInstance(modalEl);
                modal.show();
            })
            .catch(err => alert('Erro ao carregar boleto: ' + err));
    }

    function confirmarExclusaoBoleto(id) {
        if (confirm('Tem certeza que deseja excluir este boleto?')) {
            window.location.href = `/doadores/boleto/deletar/${id}`;
        }
    }

    function marcarComoPago(id) {
        if (confirm('Marcar este boleto como pago?')) {
            window.location.href = `/doadores/boleto/marcar-pago/${id}`;
        }
    }

    function marcarComoVencido(id) {
        if (confirm('Marcar este boleto como vencido?')) {
            window.location.href = `/doadores/boleto/marcar-vencido/${id}`;
        }
    }

    // ========== BUSCA/FILTRO ==========
    const buscaInput = document.getElementById('buscaDoador');
    if (buscaInput) {
        buscaInput.addEventListener('input', function() {
            const termo = this.value.toLowerCase();
            const linhas = document.querySelectorAll('#tabelaDoadores tbody tr');

            linhas.forEach(linha => {
                const texto = linha.textContent.toLowerCase();
                linha.style.display = texto.includes(termo) ? '' : 'none';
            });
        });
    }

    /*]]>*/
</script>