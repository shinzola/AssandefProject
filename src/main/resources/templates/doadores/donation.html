<!DOCTYPE html>
<html lang="pt-br" xmlns:th="http://www.thymeleaf.org">
<head th:replace="~{fragments/base :: headPadrao('Gestão de Doadores')}">
</head>

<body>

<header th:replace="~{fragments/base :: cabecalho}"></header>

<div class="container mt-3" th:if="${(msg != null and !#strings.isEmpty(msg)) or (erro != null and !#strings.isEmpty(erro))}">
    <div class="alert alert-success alert-dismissible fade show" role="alert"
         th:if="${msg != null and !#strings.isEmpty(msg)}">
        <span th:text="${msg}">Ação realizada com sucesso!</span>
        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
    </div>

    <div class="alert alert-danger alert-dismissible fade show" role="alert"
         th:if="${erro != null and !#strings.isEmpty(erro)}">
        <span th:text="${erro}">Ocorreu um erro</span>
        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
    </div>
</div>

<main class="main-page">
    <div class="container-fluid">
        <div class="page-header">
            <h1 class="page-title">Gestão de Doadores</h1>
            <div class="page-actions">
                <button
                        class="btn btn-primary"
                        data-bs-toggle="modal"
                        data-bs-target="#modalGerarRelatorioDoadores"
                >
                    <i class="bi bi-file-earmark-text me-2"></i>Gerar Relatórios
                </button>
                <button
                        class="btn btn-secondary"
                        data-bs-toggle="modal"
                        data-bs-target="#modalNovoBoleto"
                >
                    <i class="bi bi-file-earmark-text me-2"></i>Cadastrar Boleto
                </button>
            </div>
        </div>

        <ul class="nav nav-tabs mt-4" id="doadoresTabs" role="tablist">
            <li class="nav-item " role="presentation">
                <button
                        class="nav-link active p-3"
                        id="lista-doadores-tab"
                        data-bs-toggle="tab"
                        data-bs-target="#lista-doadores-pane"
                        type="button"
                        role="tab"
                        aria-controls="lista-doadores-pane"
                        aria-selected="true"
                >
                    <i class="bi bi-people-fill me-2"></i>Lista de Doadores
                </button>
            </li>
            <li class="nav-item " role="presentation">
                <button
                        class="nav-link p-3"
                        id="boletos-tab"
                        data-bs-toggle="tab"
                        data-bs-target="#boletos-pane"
                        type="button"
                        role="tab"
                        aria-controls="boletos-pane"
                        aria-selected="false"
                >
                    <i class="bi bi-file-earmark-text me-2"></i>Boletos
                </button>
            </li>
        </ul>

        <div class="tab-content card" id="doadoresTabsContent">
            <div
                    class="tab-pane fade show active"
                    id="lista-doadores-pane"
                    role="tabpanel"
                    aria-labelledby="lista-doadores-tab"
                    tabindex="0"
            >
                <div class="card-body">
                    <div class="row g-3 mb-4">
                        <div class="col-md-8">
                            <div class="input-group">
                                <input
                                        type="text"
                                        class="form-control"
                                        placeholder="Buscar por nome ou CPF/CNPJ do doador..."
                                        id="buscaDoador"
                                />
                                <button class="btn btn-outline-primary" type="button">
                                    <i class="bi bi-search"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                    <div class="table-responsive">
                        <table class="table table-hover align-middle" id="tabelaDoadores">
                            <thead class="table-light">
                            <tr>
                                <th scope="col">Nome</th>
                                <th scope="col">CPF/CNPJ</th>
                                <th scope="col">Telefone</th>
                                <th scope="col">Email</th>
                                <th scope="col">Mensalidade</th>
                                <th scope="col">Data do cadastro</th>
                                <th scope="col" class="text-end">Ações</th>
                            </tr>
                            </thead>
                            <tbody>
                            <tr th:each="doador : ${doadores}">
                                <td th:text="${doador.nome}">Nome</td>
                                <td th:text="${doador.cpfCnpj}">000.000.000-00</td>
                                <td th:text="${doador.telefone}">Telefone</td>
                                <td th:text="${doador.email}">Email</td>
                                <td th:text="${doador.mensalidade != null ? 'R$ ' + #numbers.formatDecimal(doador.mensalidade, 1, 'POINT', 2, 'COMMA') : 'N/A'}">R$ 0,00</td>
                                <td th:text="${#temporals.format(doador.dataCadastro, 'dd/MM/yyyy')}">01/01/2025</td>
                                <td class="text-end">
                                    <button
                                            class="btn btn-sm btn-outline-info me-2"
                                            title="Visualizar"
                                            data-action="visualizar-doador"
                                            th:attr="data-id=${doador.idDoador}"
                                    >
                                        <i class="bi bi-eye"></i>
                                    </button>
                                    <button
                                            th:if="${hierarquia == 1}"
                                            class="btn btn-sm btn-outline-secondary me-2"
                                            title="Editar"
                                            data-action="editar-doador"
                                            th:attr="data-id=${doador.idDoador}"
                                    >
                                        <i class="bi bi-pencil"></i>
                                    </button>
                                    <button
                                            th:if="${hierarquia == 1}"
                                            class="btn btn-sm btn-outline-danger"
                                            title="Excluir"
                                            data-action="excluir-doador"
                                            th:attr="data-id=${doador.idDoador}"
                                    >
                                        <i class="bi bi-trash"></i>
                                    </button>
                                </td>
                            </tr>
                            <tr th:if="${#lists.isEmpty(doadores)}">
                                <td colspan="7" class="text-center text-muted">Nenhum doador cadastrado</td>
                            </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <div
                    class="tab-pane fade"
                    id="boletos-pane"
                    role="tabpanel"
                    aria-labelledby="boletos-tab"
                    tabindex="0"
            >
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-hover align-middle">
                            <thead class="table-light">
                            <tr>
                                <th scope="col">Doador</th>
                                <th scope="col">Valor</th>
                                <th scope="col">Vencimento</th>
                                <th scope="col">Status</th>
                                <th scope="col">PDF</th>
                                <th scope="col" class="text-end">Ações</th>
                            </tr>
                            </thead>
                            <tbody>
                            <tr th:each="boleto : ${boletos}">
                                <td th:text="${boleto.doador != null ? boleto.doador.nome : 'N/A'}">Doador</td>
                                <td th:text="${boleto.valor != null ? 'R$ ' + #numbers.formatDecimal(boleto.valor, 1, 'POINT', 2, 'COMMA') : '-'}">R$ 0,00</td>
                                <td th:text="${boleto.dataVencimento != null ? #temporals.format(boleto.dataVencimento, 'dd/MM/yyyy') : '-'}">01/01/2025</td>
                                <td>
                                    <span th:class="${boleto.status != null ? (boleto.status.name() == 'PAGO' ? 'badge bg-success' : (boleto.status.name() == 'PENDENTE' ? 'badge bg-warning' : 'badge bg-danger')) : 'badge bg-secondary'}"
                                          th:text="${boleto.status != null ? boleto.status : 'N/A'}">Status</span>
                                </td>
                                <td>
                                    <a th:if="${boleto.pdfBoleto != null and !#strings.isEmpty(boleto.pdfBoleto)}"
                                       th:href="@{/doadores/boleto/download/{id}(id=${boleto.idBoleto})}"
                                       target="_blank"
                                       class="btn btn-md btn-outline-primary">
                                        <i class="bi bi-file-pdf me-1"></i>Ver PDF
                                    </a>
                                    <span th:if="${boleto.pdfBoleto == null or #strings.isEmpty(boleto.pdfBoleto)}"
                                          class="text-muted">Sem arquivo</span>
                                </td>
                                <td class="text-end">
                                    <button
                                            th:if="${boleto.status != null and boleto.status.name() == 'PENDENTE'}"
                                            class="btn btn-sm btn-success me-2"
                                            title="Marcar como Pago"
                                            data-action="marcar-pago"
                                            th:attr="data-id=${boleto.idBoleto}"
                                    >
                                        <i class="bi bi-check-lg text-white"></i>
                                    </button>
                                    <button
                                            th:if="${boleto.status != null and boleto.status.name() == 'PENDENTE'}"
                                            class="btn btn-sm btn-danger me-2"
                                            title="Marcar como Vencido"
                                            data-action="marcar-vencido"
                                            th:attr="data-id=${boleto.idBoleto}"
                                    >
                                        <i class="bi bi-x-lg text-white"></i>
                                    </button>
                                    <button
                                            class="btn btn-sm btn-outline-secondary me-2"
                                            title="Editar"
                                            data-action="editar-boleto"
                                            th:attr="data-id=${boleto.idBoleto}"
                                    >
                                        <i class="bi bi-pencil"></i>
                                    </button>
                                    <button
                                            class="btn btn-sm btn-outline-danger"
                                            title="Excluir"
                                            data-action="excluir-boleto"
                                            th:attr="data-id=${boleto.idBoleto}"
                                    >
                                        <i class="bi bi-trash"></i>
                                    </button>
                                </td>
                            </tr>
                            <tr th:if="${#lists.isEmpty(boletos)}">
                                <td colspan="7" class="text-center text-muted">Nenhum boleto cadastrado</td>
                            </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
</main>

<footer th:replace="~{fragments/base :: rodape}"></footer>

<div
        class="modal fade"
        id="modalEditarDoador"
        tabindex="-1"
        aria-labelledby="modalEditarDoadorLabel"
        aria-hidden="true"
>
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="modalEditarDoadorLabel">Editar Doador</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>

            <!-- form sem action fixa; o JS deve setar form.action = '/doadores/editar/{id}' -->
            <form id="editDoadorForm" method="post" class="needs-validation" novalidate>
                <!-- CSRF (garanta que o fragmento seja renderizado) -->
                <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}" />

                <!-- id do doador (será preenchido pelo JS) -->
                <input type="hidden" id="editDoadorId" name="idDoador" />

                <div class="modal-body">
                    <div class="row g-3">
                        <div class="col-12">
                            <label for="editDoadorNome" class="form-label">Nome / Razão Social</label>
                            <input type="text" class="form-control" id="editDoadorNome" name="nome" required/>
                        </div>

                        <div class="col-md-6">
                            <label for="editDoadorCpfCnpj" class="form-label">CPF / CNPJ</label>
                            <input type="text" class="form-control" id="editDoadorCpfCnpj" name="cpfCnpj" required/>
                        </div>

                        <div class="col-md-6">
                            <label for="editDoadorTelefone" class="form-label">Telefone</label>
                            <input type="text" class="form-control" id="editDoadorTelefone" name="telefone"/>
                        </div>

                        <div class="col-md-6">
                            <label for="editDoadorCep" class="form-label">CEP</label>
                            <input type="text" class="form-control" id="editDoadorCep" name="cep" maxlength="9" placeholder="00000-000"/>
                        </div>

                        <div class="col-md-6">
                            <label for="editDoadorEmail" class="form-label">Email</label>
                            <input type="email" class="form-control" id="editDoadorEmail" name="email"/>
                        </div>

                        <div class="col-md-6">
                            <label for="editDoadorNascimento" class="form-label">Data de Nascimento</label>
                            <input type="date" class="form-control" id="editDoadorNascimento" name="dataNascimento"/>
                        </div>

                        <div class="col-md-6">
                            <label for="editDoadorSexo" class="form-label">Sexo</label>
                            <select id="editDoadorSexo" class="form-select" name="sexo">
                                <option value="">Selecione...</option>
                                <option>Masculino</option>
                                <option>Feminino</option>
                                <option>Outro</option>
                                <option>Pessoa Jurídica</option>
                            </select>
                        </div>

                        <div class="col-md-6">
                            <label for="editDoadorMensalidade" class="form-label">Valor Mensalidade (R$)</label>
                            <input type="number" class="form-control" id="editDoadorMensalidade" name="mensalidade" step="0.01" placeholder="0.00"/>
                        </div>

                        <div class="col-md-6">
                            <label for="editDoadorDiaVencimento" class="form-label">Dia Preferencial Vencimento</label>
                            <input type="number" class="form-control" id="editDoadorDiaVencimento" name="diaVencimento" min="1" max="31" placeholder="Ex: 10"/>
                        </div>

                        <div class="col-12">
                            <label for="editDoadorEndereco" class="form-label">Endereço</label>
                            <input type="text" class="form-control" id="editDoadorEndereco" name="endereco" placeholder="Rua, Nº, Bairro"/>
                        </div>
                    </div>
                </div>

                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                    <button type="submit" class="btn btn-primary">Salvar Alterações</button>
                </div>
            </form>
        </div>
    </div>
</div>

<div
        class="modal fade"
        id="modalNovoBoleto"
        tabindex="-1"
        aria-labelledby="modalNovoBoletoLabel"
        aria-hidden="true"
>
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h1 class="modal-title fs-5" id="modalNovoBoletoLabel">
                    Cadastrar Novo Boleto
                </h1>
                <button
                        type="button"
                        class="btn-close"
                        data-bs-dismiss="modal"
                        aria-label="Close"
                ></button>
            </div>
            <form th:action="@{/doadores/boleto/salvar}" method="post" enctype="multipart/form-data">
                <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}" th:if="${_csrf != null}"/>
                <div class="modal-body">
                    <div class="row g-3">
                        <div class="col-12">
                            <label for="boletoDoador" class="form-label">Doador *</label>
                            <select class="form-select" id="boletoDoador" name="doador.idDoador" required>
                                <option value="">Selecione...</option>
                                <option th:each="doador : ${doadores}" th:value="${doador.idDoador}" th:text="${doador.nome}">Doador</option>
                            </select>
                        </div>
                        <div class="col-md-6">
                            <label for="boletoDataEmissao" class="form-label">Data de Emissão</label>
                            <input type="date" class="form-control" id="boletoDataEmissao" name="dataEmissao"/>
                        </div>
                        <div class="col-md-6">
                            <label for="boletoDataVencimento" class="form-label">Data de Vencimento</label>
                            <input type="date" class="form-control" id="boletoDataVencimento" name="dataVencimento"/>
                        </div>
                        <div class="col-md-6">
                            <label for="boletoValor" class="form-label">Valor (R$)</label>
                            <input type="number" class="form-control" id="boletoValor" name="valor" step="0.01" placeholder="0.00"/>
                        </div>
                        <div class="col-md-6">
                            <label for="boletoStatus" class="form-label">Status *</label>
                            <select class="form-select" id="boletoStatus" name="status" required>
                                <option value="PENDENTE" selected>Pendente</option>
                                <option value="PAGO">Pago</option>
                                <option value="VENCIDO">Vencido</option>
                            </select>
                        </div>
                        <div class="col-12">
                            <label for="boletoArquivo" class="form-label">Arquivo do Boleto (PDF) *</label>
                            <input type="file" class="form-control" id="boletoArquivo" name="arquivo" accept="application/pdf,.pdf" required/>
                            <div class="form-text">Selecione o arquivo PDF do boleto (máximo 10MB)</div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button
                            type="button"
                            class="btn btn-secondary"
                            data-bs-dismiss="modal"
                    >
                        Cancelar
                    </button>
                    <button type="submit" class="btn btn-primary">
                        Salvar Boleto
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<div
        class="modal fade"
        id="modalEditarBoleto"
        tabindex="-1"
        aria-labelledby="modalEditarBoletoLabel"
        aria-hidden="true"
>
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h1 class="modal-title fs-5" id="modalEditarBoletoLabel">
                    Editar Boleto
                </h1>
                <button
                        type="button"
                        class="btn-close"
                        data-bs-dismiss="modal"
                        aria-label="Close"
                ></button>
            </div>
            <form th:action="@{/doadores/boleto/salvar}" method="post" enctype="multipart/form-data">
                <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}" th:if="${_csrf != null}"/>
                <input type="hidden" id="editBoletoId" name="idBoleto"/>
                <div class="modal-body">
                    <div class="row g-3">
                        <div class="col-12">
                            <label for="editBoletoDoador" class="form-label">Doador *</label>
                            <select class="form-select" id="editBoletoDoador" name="doador.idDoador" required>
                                <option value="">Selecione...</option>
                                <option th:each="doador : ${doadores}" th:value="${doador.idDoador}" th:text="${doador.nome}">Doador</option>
                            </select>
                        </div>
                        <div class="col-md-6">
                            <label for="editBoletoDataEmissao" class="form-label">Data de Emissão</label>
                            <input type="date" class="form-control" id="editBoletoDataEmissao" name="dataEmissao"/>
                        </div>
                        <div class="col-md-6">
                            <label for="editBoletoDataVencimento" class="form-label">Data de Vencimento</label>
                            <input type="date" class="form-control" id="editBoletoDataVencimento" name="dataVencimento"/>
                        </div>
                        <div class="col-md-6">
                            <label for="editBoletoValor" class="form-label">Valor (R$)</label>
                            <input type="number" class="form-control" id="editBoletoValor" name="valor" step="0.01" placeholder="0.00"/>
                        </div>
                        <div class="col-md-6">
                            <label for="editBoletoStatus" class="form-label">Status *</label>
                            <select class="form-select" id="editBoletoStatus" name="status" required>
                                <option value="PENDENTE">Pendente</option>
                                <option value="PAGO">Pago</option>
                                <option value="VENCIDO">Vencido</option>
                            </select>
                        </div>
                        <div class="col-12">
                            <label for="editBoletoArquivo" class="form-label">Arquivo do Boleto (PDF)</label>
                            <input type="file" class="form-control" id="editBoletoArquivo" name="arquivo" accept="application/pdf,.pdf"/>
                            <div class="form-text">Deixe em branco para manter o arquivo atual</div>
                            <div id="arquivoAtual" class="mt-2 text-muted small"></div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button
                            type="button"
                            class="btn btn-secondary"
                            data-bs-dismiss="modal"
                    >
                        Cancelar
                    </button>
                    <button type="submit" class="btn btn-primary">
                        Salvar Alterações
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<div class="modal fade" id="modalVisualizarDoador" tabindex="-1" aria-labelledby="modalVisualizarDoadorLabel" aria-hidden="true">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header">
                <h1 class="modal-title fs-5" id="modalVisualizarDoadorLabel">
                    <i class="bi bi-person-circle me-2"></i><span id="viewDoadorNome">Detalhes do Doador</span>
                </h1>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <ul class="nav nav-tabs" id="viewDoadorTabs" role="tablist">
                    <li class="nav-item" role="presentation">
                        <button class="nav-link active" id="info-tab" data-bs-toggle="tab"
                                data-bs-target="#info-pane" type="button" role="tab">
                            <i class="bi bi-info-circle me-2"></i>Informações do Doador
                        </button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" id="boletos-doador-tab" data-bs-toggle="tab"
                                data-bs-target="#boletos-doador-pane" type="button" role="tab">
                            <i class="bi bi-file-earmark-text me-2"></i>Boletos (<span id="countBoletos">0</span>)
                        </button>
                    </li>
                </ul>

                <div class="tab-content mt-3" id="viewDoadorTabsContent">
                    <div class="tab-pane fade show active" id="info-pane" role="tabpanel">
                        <div class="row g-3">
                            <div class="col-md-6">
                                <label class="form-label fw-bold">Nome / Razão Social:</label>
                                <p class="form-control-plaintext" id="viewDoadorNomeCompleto">-</p>
                            </div>
                            <div class="col-md-3">
                                <label class="form-label fw-bold">CPF/CNPJ:</label>
                                <p class="form-control-plaintext" id="viewDoadorCpfCnpj">-</p>
                            </div>
                            <div class="col-md-3">
                                <label class="form-label fw-bold">Sexo:</label>
                                <p class="form-control-plaintext" id="viewDoadorSexo">-</p>
                            </div>
                            <div class="col-md-4">
                                <label class="form-label fw-bold">Telefone:</label>
                                <p class="form-control-plaintext" id="viewDoadorTelefone">-</p>
                            </div>
                            <div class="col-md-4">
                                <label class="form-label fw-bold">CEP:</label>
                                <p class="form-control-plaintext" id="viewDoadorCep">-</p>
                            </div>
                            <div class="col-md-4">
                                <label class="form-label fw-bold">Email:</label>
                                <p class="form-control-plaintext" id="viewDoadorEmail">-</p>
                            </div>
                            <div class="col-md-4">
                                <label class="form-label fw-bold">Data de Nascimento:</label>
                                <p class="form-control-plaintext" id="viewDoadorNascimento">-</p>
                            </div>
                            <div class="col-md-6">
                                <label class="form-label fw-bold">Endereço:</label>
                                <p class="form-control-plaintext" id="viewDoadorEndereco">-</p>
                            </div>
                            <div class="col-md-3">
                                <label class="form-label fw-bold">Mensalidade:</label>
                                <p class="form-control-plaintext text-success fw-bold" id="viewDoadorMensalidade">-</p>
                            </div>
                            <div class="col-md-3">
                                <label class="form-label fw-bold">Dia Vencimento:</label>
                                <p class="form-control-plaintext" id="viewDoadorDiaVencimento">-</p>
                            </div>
                        </div>
                    </div>

                    <div class="tab-pane fade" id="boletos-doador-pane" role="tabpanel">
                        <div id="boletosContainer">
                            <div class="text-center text-muted py-4">
                                <i class="bi bi-hourglass-split fs-1"></i>
                                <p>Carregando boletos...</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Fechar</button>
                <button type="button" class="btn btn-primary" id="btnGerarDocAssinatura" onclick="gerarDocumentacaoAssinatura()">
                    <i class="bi bi-file-earmark-arrow-up me-1"></i> Gerar Documentação para Assinatura
                </button>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="modalGerarRelatorioDoadores" tabindex="-1" aria-labelledby="modalGerarRelatorioLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <form id="formGerarRelatorio" th:action="@{/doadores/relatorio/gerar}" method="post" target="_blank">
                <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}" th:if="${_csrf != null}"/>
                <div class="modal-header">
                    <h5 class="modal-title" id="modalGerarRelatorioLabel">Gerar Relatório</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Fechar"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3">
                        <label for="relatorioTipo" class="form-label">Tipo de Relatório</label>
                        <select class="form-select" id="relatorioTipo" name="tipo" required>
                            <option value="doadores" selected>Doadores</option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Formato</label>
                        <div>
                            <div class="form-check form-check-inline">
                                <input class="form-check-input" type="radio" name="formato" id="formatoCsv" value="csv" checked>
                                <label class="form-check-label" for="formatoCsv">CSV</label>
                            </div>
                            <div class="form-check form-check-inline">
                                <input class="form-check-input" type="radio" name="formato" id="formatoPdf" value="pdf">
                                <label class="form-check-label" for="formatoPdf">PDF</label>
                            </div>
                        </div>
                    </div>
                    <div class="row g-3">
                        <div class="col-6">
                            <label for="dataInicio" class="form-label">Data Início</label>
                            <input type="date" class="form-control" id="dataInicio" name="dataInicio" required/>
                        </div>
                        <div class="col-6">
                            <label for="dataFim" class="form-label">Data Fim</label>
                            <input type="date" class="form-control" id="dataFim" name="dataFim" required/>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                    <button type="submit" class="btn btn-primary">Gerar</button>
                </div>
            </form>
        </div>
    </div>
</div>

<script
        src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"
        integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz"
        crossorigin="anonymous"
></script>

<script src="https://cdnjs.cloudflare.com/ajax/libs/imask/7.1.3/imask.min.js"></script>

<script th:inline="javascript" defer>
    /*<![CDATA[*/
    // ======================
    // MÁSCARAS DE INPUT (SEU CÓDIGO CORRETO)
    // ======================
    document.addEventListener('DOMContentLoaded', function() {
        // Máscara de Telefone (Celular ou Fixo)
        const telefoneMask = {
            mask: [
                {mask: '(00) 0000-0000'},  // Fixo
                {mask: '(00) 00000-0000'}  // Celular
            ]
        };

        const telefoneInputs = [
            document.getElementById('doadorTelefone'),
            document.getElementById('editDoadorTelefone')
        ];

        telefoneInputs.forEach(input => {
            if (input) IMask(input, telefoneMask);
        });

        // Máscara de CPF/CNPJ (dinâmica)
        const cpfCnpjMask = {
            mask: [
                {mask: '000.000.000-00', maxLength: 11},  // CPF
                {mask: '00.000.000/0000-00'}              // CNPJ
            ]
        };

        const cpfCnpjInputs = [
            document.getElementById('doadorCpfCnpj'),
            document.getElementById('editDoadorCpfCnpj')
        ];

        cpfCnpjInputs.forEach(input => {
            if (input) IMask(input, cpfCnpjMask);
        });

        // Máscara de Cep
        const cepMask = {
            mask: '00000-000'
        };

        const cepInputs = [
            document.getElementById('editDoadorCep')

        ];

        cepInputs.forEach(input => {
            if (input) IMask(input, cepMask);
        });
    });

    // ======================
    // DELEGAÇÃO DE EVENTOS (SEU CÓDIGO CORRETO)
    // ======================
    document.addEventListener('click', function (e) {
        const btn = e.target.closest('button[data-action]');
        if (!btn) return;

        const action = btn.dataset.action;
        const id = btn.dataset.id;

        switch (action) {
            case 'visualizar-doador':
                return visualizarDoador(id);
            case 'editar-doador':
                return editarDoador(id);
            case 'excluir-doador':
                return confirmarExclusaoDoador(id);
            case 'editar-boleto':
                return editarBoleto(id);
            case 'excluir-boleto':
                return confirmarExclusaoBoleto(id);
            case 'marcar-pago':
                return marcarComoPago(id);
            case 'marcar-vencido':
                return marcarComoVencido(id);
        }
    });

 // ======================
// DOADOR - VISUALIZAR (SEU CÓDIGO CORRIGIDO E INTEGRADO)
// ======================
function visualizarDoador(id) {
    fetch(`/doadores/${id}`)
        .then(r => r.json())
        .then(doador => {
            // Preencher informações básicas
            document.getElementById('viewDoadorNome').textContent = doador.nome || 'Doador';
            document.getElementById('viewDoadorNomeCompleto').textContent = doador.nome || '-';
            document.getElementById('viewDoadorCpfCnpj').textContent = doador.cpfCnpj || '-';
            document.getElementById('viewDoadorTelefone').textContent = doador.telefone || '-';
            document.getElementById('viewDoadorCep').textContent = doador.cep || '-';
            document.getElementById('viewDoadorEmail').textContent = doador.email || '-';
            document.getElementById('viewDoadorSexo').textContent = doador.sexo || '-';
            document.getElementById('viewDoadorNascimento').textContent =
                doador.dataNascimento ? new Date(doador.dataNascimento + 'T00:00:00').toLocaleDateString('pt-BR') : '-';
            document.getElementById('viewDoadorEndereco').textContent = doador.endereco || '-';
            document.getElementById('viewDoadorMensalidade').textContent =
                doador.mensalidade ? `R$ ${parseFloat(doador.mensalidade).toFixed(2).replace('.', ',')}` : '-';

            // ================== CORREÇÃO AQUI ==================
            // Corrigido para "viewDoadorDiaVencimento" e "diaVencimento"
            document.getElementById('viewDoadorDiaVencimento').textContent =
                doador.diaVencimento ? `Dia ${doador.diaVencimento}` : '-';
            // ================== FIM DA CORREÇÃO ==================

            // Guardar o id do doador no dataset da modal para uso posterior
            const modal = document.getElementById('modalVisualizarDoador');
            modal.dataset.doadorId = doador.idDoador || id;

            // Carregar boletos do doador (se tiver essa função)
            if (typeof carregarBoletosDoador === 'function') {
                carregarBoletosDoador(id);
            }

            // Abrir modal
            const bsModal = new bootstrap.Modal(modal);

            // Garantir que a primeira aba esteja ativa ao abrir
            const infoTab = document.getElementById('info-tab');
            if (infoTab) {
                const bsTab = new bootstrap.Tab(infoTab);
                bsTab.show();
            }

            bsModal.show();
        })
        .catch(err => alert('Erro ao carregar doador: ' + err));
}

// ======================
// GERAR DOCUMENTAÇÃO (PDF) - ABRIR EM NOVA ABA
// ======================
function gerarDocumentacaoAssinatura() {
    const modal = document.getElementById('modalVisualizarDoador');
    const id = modal?.dataset?.doadorId;
    if (!id) {
        alert('ID do doador não definido. Reabra a ficha e tente novamente.');
        return;
    }

    // Abre o PDF gerado pelo backend em nova aba
    const url = `/doadores/relatorio/documentacao/${id}`;
    window.open(url, '_blank');
}

    // ======================
    // CARREGAR BOLETOS DO DOADOR (SEU CÓDIGO CORRETO)
    // ======================
    function carregarBoletosDoador(idDoador) {
        const container = document.getElementById('boletosContainer');
        container.innerHTML = '<div class="text-center"><div class="spinner-border" role="status"></div><p>Carregando...</p></div>';

        fetch(`/doadores/${idDoador}/boletos`)
            .then(r => r.json())
            .then(boletos => {
                document.getElementById('countBoletos').textContent = boletos.length;

                if (boletos.length === 0) {
                    container.innerHTML = `
                        <div class="alert alert-info">
                            <i class="bi bi-info-circle me-2"></i>
                            Nenhum boleto cadastrado para este doador.
                        </div>
                    `;
                    return;
                }

                // Agrupar boletos por mês
                const boletosPorMes = {};
                boletos.forEach(boleto => {
                    let mesAno = 'Sem data';
                    let valor = 0;

                    if (boleto.dataVencimento) {
                        const data = new Date(boleto.dataVencimento + 'T00:00:00');
                        const mes = data.toLocaleString('pt-BR', { month: 'long', year: 'numeric' });
                        mesAno = mes.charAt(0).toUpperCase() + mes.slice(1);
                    }

                    if (!boletosPorMes[mesAno]) {
                        boletosPorMes[mesAno] = {
                            boletos: [],
                            total: 0
                        };
                    }

                    valor = boleto.valor ? parseFloat(boleto.valor) : 0;
                    boletosPorMes[mesAno].boletos.push(boleto);
                    boletosPorMes[mesAno].total += valor;
                });

                // Renderizar HTML
                let html = '';
                for (const [mes, dados] of Object.entries(boletosPorMes)) {
                    const totalFormatado = dados.total.toFixed(2).replace('.', ',');

                    html += `
                        <div class="card mb-3">
                            <div class="card-header bg-primary text-white">
                                <i class="bi bi-calendar-month me-2"></i>
                                <strong>${mes}</strong>
                                <span class="float-end">Total: R$ ${totalFormatado}</span>
                            </div>
                            <div class="card-body">
                                <div class="list-group">
                    `;

                    dados.boletos.forEach(boleto => {
                        const statusClass =
                            boleto.status === 'PAGO' ? 'success' :
                            boleto.status === 'PENDENTE' ? 'warning' : 'danger';

                        const dataVenc = boleto.dataVencimento ?
                            new Date(boleto.dataVencimento + 'T00:00:00').toLocaleDateString('pt-BR') : '-';

                        const valorBoleto = boleto.valor ?
                            parseFloat(boleto.valor).toFixed(2).replace('.', ',') : '0,00';

                        const pdfLink = boleto.pdfBoleto ?
                            `<a href="/doadores/boleto/download/${boleto.idBoleto}" target="_blank" class="btn btn-sm btn-outline-primary">
                                <i class="bi bi-file-pdf"></i> Ver PDF
                            </a>` :
                            '<span class="text-muted">Sem PDF</span>';

                        html += `
                            <div class="list-group-item">
                                <div class="d-flex justify-content-between align-items-center">
                                    <div>
                                        <h6 class="mb-1">
                                            <span class="badge bg-${statusClass}">${boleto.status}</span>
                                            Boleto #${boleto.idBoleto}
                                        </h6>
                                        <small class="text-muted">
                                            <i class="bi bi-calendar3 me-1"></i>Vencimento: ${dataVenc}
                                        </small>
                                    </div>
                                    <div class="text-end">
                                        <div class="fw-bold text-success mb-2">R$ ${valorBoleto}</div>
                                        ${pdfLink}
                                    </div>
                                </div>
                            </div>
                        `;
                    });

                    html += `
                                </div>
                            </div>
                        </div>
                    `;
                }

                container.innerHTML = html;
            })
            .catch(err => {
                container.innerHTML = `
                    <div class="alert alert-danger">
                        <i class="bi bi-exclamation-triangle me-2"></i>
                        Erro ao carregar boletos: ${err}
                    </div>
                `;
                document.getElementById('countBoletos').textContent = '!';
            });
    }

    // ========== DOADOR - EDITAR (JAVASCRIPT COM ACTION DINÂMICA) ==========
function editarDoador(id) {
    fetch(`/doadores/${id}`)
        .then(r => {
            if (!r.ok) throw new Error('Doador não encontrado');
            return r.json();
        })
        .then(doador => {
            // Preencher campos do formulário
            document.getElementById('editDoadorId').value = doador.idDoador || '';
            document.getElementById('editDoadorNome').value = doador.nome || '';
            document.getElementById('editDoadorCpfCnpj').value = doador.cpfCnpj || '';
            document.getElementById('editDoadorTelefone').value = doador.telefone || '';
            document.getElementById('editDoadorCep').value = doador.cep || '';
            document.getElementById('editDoadorEmail').value = doador.email || '';

            // Normalizar data para formato yyyy-MM-dd
            let data = doador.dataNascimento || '';
            if (data && data.indexOf('T') !== -1) {
                data = data.split('T')[0];
            }
            document.getElementById('editDoadorNascimento').value = data;

            // Selecionar sexo pelo texto (compatível com options fixas)
            const sexoSelect = document.getElementById('editDoadorSexo');
            if (doador.sexo) {
                Array.from(sexoSelect.options).forEach(opt =>
                    opt.selected = (opt.text === doador.sexo)
                );
            } else {
                sexoSelect.value = '';
            }

            document.getElementById('editDoadorMensalidade').value = doador.mensalidade != null ? doador.mensalidade : '';
            document.getElementById('editDoadorDiaVencimento').value = doador.diaVencimento != null ? doador.diaVencimento : '';
            document.getElementById('editDoadorEndereco').value = doador.endereco || '';

            // === AJUSTE CRÍTICO: SETAR ACTION DINAMICAMENTE PARA /doadores/editar/{id} ===
            const form = document.getElementById('editDoadorForm');
            if (form) {
                form.action = `/doadores/editar/${id}`;
            } else {
                console.error('Formulário #editDoadorForm não encontrado!');
                alert('Erro ao preparar formulário de edição.');
                return;
            }

            // Abrir modal
            const modalEl = document.getElementById('modalEditarDoador');
            if (!modalEl) {
                console.error('Modal #modalEditarDoador não encontrado!');
                alert('Erro ao abrir modal de edição.');
                return;
            }
            const modal = bootstrap.Modal.getOrCreateInstance(modalEl);
            modal.show();
        })
        .catch(err => {
            console.error('Erro ao carregar doador:', err);
            alert('Erro ao carregar doador: ' + err.message);
        });
}

    function confirmarExclusaoDoador(id) {
        if (confirm('Tem certeza que deseja excluir este doador?')) {
            window.location.href = `/doadores/deletar/${id}`;
        }
    }

    // ========== BOLETO (SEU CÓDIGO CORRETO) ==========
    function editarBoleto(id) {
        fetch(`/doadores/boleto/${id}`)
            .then(r => r.json())
            .then(boleto => {
                document.getElementById('editBoletoId').value = boleto.idBoleto;
                document.getElementById('editBoletoDoador').value =
                    (boleto.doador && boleto.doador.idDoador) ? boleto.doador.idDoador : '';
                document.getElementById('editBoletoStatus').value = boleto.status || 'PENDENTE';
                document.getElementById('editBoletoDataEmissao').value = boleto.dataEmissao || '';
                document.getElementById('editBoletoDataVencimento').value = boleto.dataVencimento || '';
                document.getElementById('editBoletoValor').value = boleto.valor || '';

                // Mostrar arquivo atual se existir
                const arquivoAtualDiv = document.getElementById('arquivoAtual');
                if (boleto.pdfBoleto && boleto.pdfBoleto.length > 0) {
                    // Extrai o nome do arquivo do caminho (mesmo que seja complexo)
                    const nomeArquivo = boleto.pdfBoleto.split(/[\\/]/).pop();
                    arquivoAtualDiv.innerHTML = `📄 Arquivo atual: ${nomeArquivo}`;
                } else {
                    arquivoAtualDiv.innerHTML = 'Nenhum arquivo anexado';
                }

                // Limpar o campo de input de arquivo
                document.getElementById('editBoletoArquivo').value = null;

                const modalEl = document.getElementById('modalEditarBoleto');
                if (!modalEl) return console.error('Elemento #modalEditarBoleto não encontrado');
                const modal = bootstrap.Modal.getOrCreateInstance(modalEl);
                modal.show();
            })
            .catch(err => alert('Erro ao carregar boleto: ' + err));
    }

    function confirmarExclusaoBoleto(id) {
        if (confirm('Tem certeza que deseja excluir este boleto?')) {
            window.location.href = `/doadores/boleto/deletar/${id}`;
        }
    }

    function marcarComoPago(id) {
        if (confirm('Marcar este boleto como pago?')) {
            window.location.href = `/doadores/boleto/marcar-pago/${id}`;
        }
    }

    function marcarComoVencido(id) {
        if (confirm('Marcar este boleto como vencido?')) {
            window.location.href = `/doadores/boleto/marcar-vencido/${id}`;
        }
    }

    // ========== BUSCA/FILTRO (SEU CÓDIGO CORRETO) ==========
    const buscaInput = document.getElementById('buscaDoador');
    if (buscaInput) {
        buscaInput.addEventListener('input', function() {
            const termo = this.value.toLowerCase();
            const linhas = document.querySelectorAll('#tabelaDoadores tbody tr');

            linhas.forEach(linha => {
                const texto = linha.textContent.toLowerCase();
                linha.style.display = texto.includes(termo) ? '' : 'none';
            });
        });
    }

    /*]]>*/
</script>
</body>
</html>